<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.mritd.me/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//piwik.mritd.me/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Teleport 跳板机部署 &mdash; 漠然</title>
    <link rel="stylesheet" href="https://mritd.b0.upaiyun.com/assets/vendor/primer-css/css/primer.css">
    <link rel="stylesheet" href="https://mritd.b0.upaiyun.com/assets/vendor/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="https://mritd.b0.upaiyun.com/assets/vendor/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="https://mritd.b0.upaiyun.com/assets/css/components/collection.css">
    <link rel="stylesheet" href="https://mritd.b0.upaiyun.com/assets/css/components/repo-card.css">
    <link rel="stylesheet" href="https://mritd.b0.upaiyun.com/assets/css/sections/repo-list.css">
    <link rel="stylesheet" href="https://mritd.b0.upaiyun.com/assets/css/sections/mini-repo-list.css">
    <link rel="stylesheet" href="https://mritd.b0.upaiyun.com/assets/css/components/boxed-group.css">
    <link rel="stylesheet" href="https://mritd.b0.upaiyun.com/assets/css/globals/common.css">
    <link rel="stylesheet" href="https://mritd.b0.upaiyun.com/assets/vendor/share.js/dist/css/share.min.css">
    <link rel="stylesheet" href="https://mritd.b0.upaiyun.com/assets/css/globals/responsive.css">
    <link rel="stylesheet" href="https://mritd.b0.upaiyun.com/assets/css/posts/index.css">
    <!-- Latest compiled and minified CSS -->
    

    
    <link rel="canonical" href="https://mritd.me/2017/11/09/set-up-teleport/">
    <link rel="alternate" type="application/atom+xml" title="漠然" href="/feed.xml">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <meta property="og:title" content="Teleport 跳板机部署">
      
    <meta name="keywords" content="Teleport 跳板机">
    <meta name="og:keywords" content="Teleport 跳板机">
      
    <meta name="description" content="  由于业务需求，以前账号管理混乱，所以很多人有生产服务器的 root 权限；所以目前需要一个能 ssh 登录线上服务器的工具，同时具有简单的审计功能；找了好久找到了这个小工具，以下记录一下搭建教程">
    <meta name="og:description" content="  由于业务需求，以前账号管理混乱，所以很多人有生产服务器的 root 权限；所以目前需要一个能 ssh 登录线上服务器的工具，同时具有简单的审计功能；找了好久找到了这个小工具，以下记录一下搭建教程">
      
    
    
        
    
    <meta property="og:url" content="https://mritd.me/2017/11/09/set-up-teleport/">
    <meta property="og:site_name" content="漠然">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh_CN" />
    
    <meta property="article:published_time" content="2017-11-09">
    
    <script src="https://mritd.b0.upaiyun.com/assets/vendor/jquery/dist/jquery.min.js"></script>
    <script src="https://mritd.b0.upaiyun.com/assets/js/jquery-ui.js"></script>
    <script type="text/javascript">
    function toggleMenu() {
        var nav = document.getElementsByClassName("site-header-nav")[0];
        if (nav.style.display == "inline-flex") {
          nav.style.display = "none";
        } else {
          nav.style.display = "inline-flex";
        }
    }
    </script>
</head>
<body class="" data-mz="">
    <header class="site-header">
        <div class="container">
            <h1><a href="/" title="漠然"><span class="octicon octicon-mark-github"></span> 漠然</a></h1>
            <button class="collapsed mobile-visible" type="button" onclick="toggleMenu();">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <nav class="site-header-nav" role="navigation">
                
                <a href="/" class=" site-header-nav-item" target="" title="首页">首页</a>
                
                <a href="/categories/" class=" site-header-nav-item" target="" title="分类">分类</a>
                
                <a href="/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a>
                
                <a href="/open-source/" class=" site-header-nav-item" target="" title="开源">开源</a>
                
                <a href="/links/" class=" site-header-nav-item" target="" title="链接">链接</a>
                
                <a href="/about/" class=" site-header-nav-item" target="" title="关于">关于</a>
                
            </nav>
        </div>
    </header>
    <!-- / header -->

    <section class="collection-head small geopattern" data-pattern-id="Teleport 跳板机部署">
<div class="container">
  <div class="columns">
    <div class="column three-fourths">
      <div class="collection-title">
        <h1 class="collection-header">Teleport 跳板机部署</h1>
        <div class="collection-info">
          
          <span class="meta-info">
            <span class="octicon octicon-calendar"></span> 2017/11/09
          </span>
          
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="/categories/#Linux" title="Linux">Linux</a>
          </span>
          
        </div>
      </div>
    </div>
  </div>
</div>
</section>
<!-- / .banner -->
<section class="container content">
<div class="columns">
  <div class="column three-fourths" >
    <article class="article-content markdown-body">
    <blockquote>
  <p>由于业务需求，以前账号管理混乱，所以很多人有生产服务器的 root 权限；所以目前需要一个能 ssh 登录线上服务器的工具，同时具有简单的审计功能；找了好久找到了这个小工具，以下记录一下搭建教程</p>
</blockquote>

<h3 id="一环境准备">一、环境准备</h3>

<p>目前准备了 3 台虚拟机，两台位于内网 NAT 之后，一台位于公网可以直接链接；使用时客户端通过工具连接到公网跳板机上，然后实现自动跳转到内网任意主机；并且具有相应的操作回放审计，通过宿主机账户限制用户权限</p>

<table>
  <thead>
    <tr>
      <th>ip</th>
      <th>节点</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>92.223.67.84</td>
      <td>公网 Master</td>
    </tr>
    <tr>
      <td>172.16.0.80</td>
      <td>内网 Master</td>
    </tr>
    <tr>
      <td>172.16.0.81</td>
      <td>内网 Node</td>
    </tr>
  </tbody>
</table>

<h3 id="二teleport-工作模式">二、Teleport 工作模式</h3>

<p>Teleport 工作时从宏观上看是以集群为单位，也就是说<strong>公网算作一个集群，内网算作另一个集群，内网集群通过 ssh 隧道保持跟公网的链接状态，同时内网机群允许公网集群用户连接</strong>，大体工作模式如下</p>

<p><img src="https://mritd.b0.upaiyun.com/markdown/hsnj8.png" alt="Teleport 工作模式" /></p>

<h3 id="三搭建公网-master">三、搭建公网 Master</h3>

<h4 id="31配置-systemd">3.1、配置 Systemd</h4>

<p>首先下载相关可执行文件并复制到 Path 目录下，然后创建一下配置目录等</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://github.com/gravitational/teleport/releases/download/v2.3.5/teleport-v2.3.5-linux-amd64-bin.tar.gz
<span class="nb">tar</span> <span class="nt">-zxvf</span> teleport-v2.3.5-linux-amd64-bin.tar.gz
mv teleport/tctl teleport/teleport teleport/tsh /usr/local/bin
mkdir <span class="nt">-p</span> /etc/teleport /data/teleport
</code></pre></div></div>

<p>然后为了让服务后台运行创建一个 systemd service 配置文件</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&gt;</span> /etc/systemd/system/teleport.service <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
[Unit]
Description=Teleport SSH Service
After=network.target

[Service]
Type=simple
Restart=always
ExecStart=/usr/local/bin/teleport start -c /etc/teleport/teleport.yaml

[Install]
WantedBy=multi-user.target
</span><span class="no">EOF
</span></code></pre></div></div>

<h4 id="32配置-teleport">3.2、配置 Teleport</h4>

<p>Systemd 配置完成后，就需要写一个 Teleport 的配置文件来让 Teleport 启动，具体选项含义可以参考 <a href="https://gravitational.com/teleport/docs/2.3/admin-guide/">官方文档</a>；以下为我的配置样例</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># By default, this file should be stored in /etc/teleport.yaml</span>

<span class="c1"># This section of the configuration file applies to all teleport</span>
<span class="c1"># services.</span>
<span class="na">teleport</span><span class="pi">:</span>
    <span class="c1"># nodename allows to assign an alternative name this node can be reached by.</span>
    <span class="c1"># by default it's equal to hostname</span>
    <span class="na">nodename</span><span class="pi">:</span> <span class="s">mritd.master</span>

    <span class="c1"># Data directory where Teleport keeps its data, like keys/users for</span>
    <span class="c1"># authentication (if using the default BoltDB back-end)</span>
    <span class="na">data_dir</span><span class="pi">:</span> <span class="s">/data/teleport</span>

    <span class="c1"># one-time invitation token used to join a cluster. it is not used on</span>
    <span class="c1"># subsequent starts</span>
    <span class="na">auth_token</span><span class="pi">:</span> <span class="s">jYektagNTmhjv9Dh</span>

    <span class="c1"># when running in multi-homed or NATed environments Teleport nodes need</span>
    <span class="c1"># to know which IP it will be reachable at by other nodes</span>
    <span class="na">advertise_ip</span><span class="pi">:</span> <span class="s">92.223.67.84</span>

    <span class="c1"># list of auth servers in a cluster. you will have more than one auth server</span>
    <span class="c1"># if you configure teleport auth to run in HA configuration</span>
    <span class="na">auth_servers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">0.0.0.0:3025</span>
        <span class="pi">-</span> <span class="s">0.0.0.0:3025</span>

    <span class="c1"># Teleport throttles all connections to avoid abuse. These settings allow</span>
    <span class="c1"># you to adjust the default limits</span>
    <span class="na">connection_limits</span><span class="pi">:</span>
        <span class="na">max_connections</span><span class="pi">:</span> <span class="s">1000</span>
        <span class="na">max_users</span><span class="pi">:</span> <span class="s">250</span>

    <span class="c1"># Logging configuration. Possible output values are 'stdout', 'stderr' and</span>
    <span class="c1"># 'syslog'. Possible severity values are INFO, WARN and ERROR (default).</span>
    <span class="na">log</span><span class="pi">:</span>
        <span class="na">output</span><span class="pi">:</span> <span class="s">stdout</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">INFO</span>

    <span class="c1"># Type of storage used for keys. You need to configure this to use etcd</span>
    <span class="c1"># backend if you want to run Teleport in HA configuration.</span>
    <span class="na">storage</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">bolt</span>

    <span class="c1"># Cipher algorithms that the server supports. This section only needs to be</span>
    <span class="c1"># set if you want to override the defaults.</span>
    <span class="na">ciphers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">aes128-ctr</span>
      <span class="pi">-</span> <span class="s">aes192-ctr</span>
      <span class="pi">-</span> <span class="s">aes256-ctr</span>
      <span class="pi">-</span> <span class="s">aes128-gcm@openssh.com</span>
      <span class="pi">-</span> <span class="s">arcfour256</span>
      <span class="pi">-</span> <span class="s">arcfour128</span>

    <span class="c1"># Key exchange algorithms that the server supports. This section only needs</span>
    <span class="c1"># to be set if you want to override the defaults.</span>
    <span class="na">kex_algos</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">curve25519-sha256@libssh.org</span>
      <span class="pi">-</span> <span class="s">ecdh-sha2-nistp256</span>
      <span class="pi">-</span> <span class="s">ecdh-sha2-nistp384</span>
      <span class="pi">-</span> <span class="s">ecdh-sha2-nistp521</span>
      <span class="pi">-</span> <span class="s">diffie-hellman-group14-sha1</span>
      <span class="pi">-</span> <span class="s">diffie-hellman-group1-sha1</span>

    <span class="c1"># Message authentication code (MAC) algorithms that the server supports.</span>
    <span class="c1"># This section only needs to be set if you want to override the defaults.</span>
    <span class="na">mac_algos</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">hmac-sha2-256-etm@openssh.com</span>
      <span class="pi">-</span> <span class="s">hmac-sha2-256</span>
      <span class="pi">-</span> <span class="s">hmac-sha1</span>
      <span class="pi">-</span> <span class="s">hmac-sha1-96</span>

<span class="c1"># This section configures the 'auth service':</span>
<span class="na">auth_service</span><span class="pi">:</span>
    <span class="c1"># Turns 'auth' role on. Default is 'yes'</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="s">yes</span>

    <span class="na">authentication</span><span class="pi">:</span>
        <span class="c1"># default authentication type. possible values are 'local', 'oidc' and 'saml'</span>
        <span class="c1"># only local authentication (Teleport's own user DB) is supported in the open</span>
        <span class="c1"># source version</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">local</span>
        <span class="c1"># second_factor can be off, otp, or u2f</span>
        <span class="na">second_factor</span><span class="pi">:</span> <span class="s">otp</span>
        <span class="c1"># this section is used if second_factor is set to 'u2f'</span>
        <span class="c1">#u2f:</span>
        <span class="c1">#    # app_id must point to the URL of the Teleport Web UI (proxy) accessible</span>
        <span class="c1">#    # by the end users</span>
        <span class="c1">#    app_id: https://localhost:3080</span>
        <span class="c1">#    # facets must list all proxy servers if there are more than one deployed</span>
        <span class="c1">#    facets:</span>
        <span class="c1">#    - https://localhost:3080</span>

    <span class="c1"># IP and the port to bind to. Other Teleport nodes will be connecting to</span>
    <span class="c1"># this port (AKA "Auth API" or "Cluster API") to validate client</span>
    <span class="c1"># certificates</span>
    <span class="na">listen_addr</span><span class="pi">:</span> <span class="s">0.0.0.0:3025</span>

    <span class="c1"># Pre-defined tokens for adding new nodes to a cluster. Each token specifies</span>
    <span class="c1"># the role a new node will be allowed to assume. The more secure way to</span>
    <span class="c1"># add nodes is to use `ttl node add --ttl` command to generate auto-expiring</span>
    <span class="c1"># tokens.</span>
    <span class="c1">#</span>
    <span class="c1"># We recommend to use tools like `pwgen` to generate sufficiently random</span>
    <span class="c1"># tokens of 32+ byte length.</span>
    <span class="na">tokens</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">proxy,node:jYektagNTmhjv9Dh"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">auth:jYektagNTmhjv9Dh"</span>

    <span class="c1"># Optional "cluster name" is needed when configuring trust between multiple</span>
    <span class="c1"># auth servers. A cluster name is used as part of a signature in certificates</span>
    <span class="c1"># generated by this CA.</span>
    <span class="c1">#</span>
    <span class="c1"># By default an automatically generated GUID is used.</span>
    <span class="c1">#</span>
    <span class="c1"># IMPORTANT: if you change cluster_name, it will invalidate all generated</span>
    <span class="c1"># certificates and keys (may need to wipe out /var/lib/teleport directory)</span>
    <span class="na">cluster_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">mritd"</span>

<span class="c1"># This section configures the 'node service':</span>
<span class="na">ssh_service</span><span class="pi">:</span>
    <span class="c1"># Turns 'ssh' role on. Default is 'yes'</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="s">yes</span>

    <span class="c1"># IP and the port for SSH service to bind to.</span>
    <span class="na">listen_addr</span><span class="pi">:</span> <span class="s">0.0.0.0:3022</span>
    <span class="c1"># See explanation of labels in "Labeling Nodes" section below</span>
    <span class="na">labels</span><span class="pi">:</span>
        <span class="na">role</span><span class="pi">:</span> <span class="s">master</span>

    <span class="c1"># List of the commands to periodically execute. Their output will be used as node labels.</span>
    <span class="c1"># See "Labeling Nodes" section below for more information.</span>
    <span class="na">commands</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">arch</span>             <span class="c1"># this command will add a label like 'arch=x86_64' to a node</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">uname</span><span class="pi">,</span> <span class="nv">-p</span><span class="pi">]</span>
      <span class="na">period</span><span class="pi">:</span> <span class="s">1h0m0s</span>

    <span class="c1"># enables reading ~/.tsh/environment before creating a session. by default</span>
    <span class="c1"># set to false, can be set true here or as a command line flag.</span>
    <span class="na">permit_user_env</span><span class="pi">:</span> <span class="no">false</span>

<span class="c1"># This section configures the 'proxy servie'</span>
<span class="na">proxy_service</span><span class="pi">:</span>
    <span class="c1"># Turns 'proxy' role on. Default is 'yes'</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="s">yes</span>

    <span class="c1"># SSH forwarding/proxy address. Command line (CLI) clients always begin their</span>
    <span class="c1"># SSH sessions by connecting to this port</span>
    <span class="na">listen_addr</span><span class="pi">:</span> <span class="s">0.0.0.0:3023</span>

    <span class="c1"># Reverse tunnel listening address. An auth server (CA) can establish an</span>
    <span class="c1"># outbound (from behind the firewall) connection to this address.</span>
    <span class="c1"># This will allow users of the outside CA to connect to behind-the-firewall</span>
    <span class="c1"># nodes.</span>
    <span class="na">tunnel_listen_addr</span><span class="pi">:</span> <span class="s">0.0.0.0:3024</span>

    <span class="c1"># The HTTPS listen address to serve the Web UI and also to authenticate the</span>
    <span class="c1"># command line (CLI) users via password+HOTP</span>
    <span class="na">web_listen_addr</span><span class="pi">:</span> <span class="s">0.0.0.0:3080</span>

    <span class="c1"># TLS certificate for the HTTPS connection. Configuring these properly is</span>
    <span class="c1"># critical for Teleport security.</span>
    <span class="c1">#https_key_file: /var/lib/teleport/webproxy_key.pem</span>
    <span class="c1">#https_cert_file: /var/lib/teleport/webproxy_cert.pem</span>
</code></pre></div></div>

<p>然后启动 Teleport 即可</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl <span class="nb">enable </span>teleport
systemctl start teleport
</code></pre></div></div>

<p>如果启动出现如下错误</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error: Could not load host key: /etc/ssh/ssh_host_ecdsa_key
error: Could not load host key: /etc/ssh/ssh_host_ed25519_key
</code></pre></div></div>

<p>请执行 ssh-keygen 命令自行生成相关秘钥</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen <span class="nt">-t</span> ecdsa <span class="nt">-f</span> /etc/ssh/ssh_host_ecdsa_key
ssh-keygen <span class="nt">-t</span> ed25519 <span class="nt">-f</span> /etc/ssh/ssh_host_ed25519_key
</code></pre></div></div>

<h4 id="33添加用户">3.3、添加用户</h4>

<p>公网这台 Teleport 将会作为主要的接入机器，所以在此节点内添加的用户将有权限登录所有集群，包括内网的另一个集群；所以为了方便以后操作先添加一个用户</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 添加一个用户名为 mritd 的用户，该用户在所有集群具有 root 用户权限</span>
tctl <span class="nt">--config</span> /etc/teleport/teleport.yaml users add mritd root
</code></pre></div></div>

<p>添加成功后会返回一个 OTP 认证初始化地址，浏览器访问后可以使用 Google 扫描 OTP 二维码从而在登录时增加一层 OTP 认证</p>

<p><img src="https://mritd.b0.upaiyun.com/markdown/chuyf.png" alt="OTP CMD" /></p>

<p>访问该地址后初始化密码及 OTP</p>

<p><img src="https://mritd.b0.upaiyun.com/markdown/czwmd.png" alt="init OTP" /></p>

<h3 id="四搭建内网-master">四、搭建内网 Master</h3>

<p>内网搭建 Master 和公网类似，只不过为了安全将所有 <code class="highlighter-rouge">0.0.0.0</code> 的地址全部换成内网 IP 即可，以下为内网的配置信息</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># By default, this file should be stored in /etc/teleport.yaml</span>

<span class="c1"># This section of the configuration file applies to all teleport</span>
<span class="c1"># services.</span>
<span class="na">teleport</span><span class="pi">:</span>
    <span class="c1"># nodename allows to assign an alternative name this node can be reached by.</span>
    <span class="c1"># by default it's equal to hostname</span>
    <span class="na">nodename</span><span class="pi">:</span> <span class="s">mritd.test1</span>

    <span class="c1"># Data directory where Teleport keeps its data, like keys/users for</span>
    <span class="c1"># authentication (if using the default BoltDB back-end)</span>
    <span class="na">data_dir</span><span class="pi">:</span> <span class="s">/data/teleport</span>

    <span class="c1"># one-time invitation token used to join a cluster. it is not used on</span>
    <span class="c1"># subsequent starts</span>
    <span class="na">auth_token</span><span class="pi">:</span> <span class="s">jYektagNTmhjv9Dh</span>

    <span class="c1"># when running in multi-homed or NATed environments Teleport nodes need</span>
    <span class="c1"># to know which IP it will be reachable at by other nodes</span>
    <span class="na">advertise_ip</span><span class="pi">:</span> <span class="s">172.16.0.80</span>

    <span class="c1"># list of auth servers in a cluster. you will have more than one auth server</span>
    <span class="c1"># if you configure teleport auth to run in HA configuration</span>
    <span class="na">auth_servers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">172.16.0.80:3025</span>

    <span class="c1"># Teleport throttles all connections to avoid abuse. These settings allow</span>
    <span class="c1"># you to adjust the default limits</span>
    <span class="na">connection_limits</span><span class="pi">:</span>
        <span class="na">max_connections</span><span class="pi">:</span> <span class="s">1000</span>
        <span class="na">max_users</span><span class="pi">:</span> <span class="s">250</span>

    <span class="c1"># Logging configuration. Possible output values are 'stdout', 'stderr' and</span>
    <span class="c1"># 'syslog'. Possible severity values are INFO, WARN and ERROR (default).</span>
    <span class="na">log</span><span class="pi">:</span>
        <span class="na">output</span><span class="pi">:</span> <span class="s">stdout</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">INFO</span>

    <span class="c1"># Type of storage used for keys. You need to configure this to use etcd</span>
    <span class="c1"># backend if you want to run Teleport in HA configuration.</span>
    <span class="na">storage</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">bolt</span>

    <span class="c1"># Cipher algorithms that the server supports. This section only needs to be</span>
    <span class="c1"># set if you want to override the defaults. </span>
    <span class="na">ciphers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">aes128-ctr</span>
      <span class="pi">-</span> <span class="s">aes192-ctr</span>
      <span class="pi">-</span> <span class="s">aes256-ctr</span>
      <span class="pi">-</span> <span class="s">aes128-gcm@openssh.com</span>
      <span class="pi">-</span> <span class="s">arcfour256</span>
      <span class="pi">-</span> <span class="s">arcfour128</span>

    <span class="c1"># Key exchange algorithms that the server supports. This section only needs</span>
    <span class="c1"># to be set if you want to override the defaults.</span>
    <span class="na">kex_algos</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">curve25519-sha256@libssh.org</span>
      <span class="pi">-</span> <span class="s">ecdh-sha2-nistp256</span>
      <span class="pi">-</span> <span class="s">ecdh-sha2-nistp384</span>
      <span class="pi">-</span> <span class="s">ecdh-sha2-nistp521</span>
      <span class="pi">-</span> <span class="s">diffie-hellman-group14-sha1</span>
      <span class="pi">-</span> <span class="s">diffie-hellman-group1-sha1</span>

    <span class="c1"># Message authentication code (MAC) algorithms that the server supports.</span>
    <span class="c1"># This section only needs to be set if you want to override the defaults.</span>
    <span class="na">mac_algos</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">hmac-sha2-256-etm@openssh.com</span>
      <span class="pi">-</span> <span class="s">hmac-sha2-256</span>
      <span class="pi">-</span> <span class="s">hmac-sha1</span>
      <span class="pi">-</span> <span class="s">hmac-sha1-96</span>

<span class="c1"># This section configures the 'auth service':</span>
<span class="na">auth_service</span><span class="pi">:</span>
    <span class="c1"># Turns 'auth' role on. Default is 'yes'</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="s">yes</span>

    <span class="na">authentication</span><span class="pi">:</span>
        <span class="c1"># default authentication type. possible values are 'local', 'oidc' and 'saml'</span>
        <span class="c1"># only local authentication (Teleport's own user DB) is supported in the open</span>
        <span class="c1"># source version</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">local</span>
        <span class="c1"># second_factor can be off, otp, or u2f</span>
        <span class="na">second_factor</span><span class="pi">:</span> <span class="s">otp</span>
        <span class="c1"># this section is used if second_factor is set to 'u2f'</span>
        <span class="c1">#u2f:</span>
        <span class="c1">#    # app_id must point to the URL of the Teleport Web UI (proxy) accessible</span>
        <span class="c1">#    # by the end users</span>
        <span class="c1">#    app_id: https://localhost:3080</span>
        <span class="c1">#    # facets must list all proxy servers if there are more than one deployed</span>
        <span class="c1">#    facets:</span>
        <span class="c1">#    - https://localhost:3080</span>

    <span class="c1"># IP and the port to bind to. Other Teleport nodes will be connecting to</span>
    <span class="c1"># this port (AKA "Auth API" or "Cluster API") to validate client</span>
    <span class="c1"># certificates</span>
    <span class="na">listen_addr</span><span class="pi">:</span> <span class="s">172.16.0.80:3025</span>

    <span class="c1"># Pre-defined tokens for adding new nodes to a cluster. Each token specifies</span>
    <span class="c1"># the role a new node will be allowed to assume. The more secure way to</span>
    <span class="c1"># add nodes is to use `ttl node add --ttl` command to generate auto-expiring</span>
    <span class="c1"># tokens.</span>
    <span class="c1">#</span>
    <span class="c1"># We recommend to use tools like `pwgen` to generate sufficiently random</span>
    <span class="c1"># tokens of 32+ byte length.</span>
    <span class="na">tokens</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">proxy,node:jYektagNTmhjv9Dh"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">auth:jYektagNTmhjv9Dh"</span>

    <span class="c1"># Optional "cluster name" is needed when configuring trust between multiple</span>
    <span class="c1"># auth servers. A cluster name is used as part of a signature in certificates</span>
    <span class="c1"># generated by this CA.</span>
    <span class="c1">#</span>
    <span class="c1"># By default an automatically generated GUID is used.</span>
    <span class="c1">#</span>
    <span class="c1"># IMPORTANT: if you change cluster_name, it will invalidate all generated</span>
    <span class="c1"># certificates and keys (may need to wipe out /var/lib/teleport directory)</span>
    <span class="na">cluster_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nat"</span>

<span class="c1"># This section configures the 'node service':</span>
<span class="na">ssh_service</span><span class="pi">:</span>
    <span class="c1"># Turns 'ssh' role on. Default is 'yes'</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="s">yes</span>

    <span class="c1"># IP and the port for SSH service to bind to.</span>
    <span class="na">listen_addr</span><span class="pi">:</span> <span class="s">172.16.0.80:3022</span>
    <span class="c1"># See explanation of labels in "Labeling Nodes" section below</span>
    <span class="na">labels</span><span class="pi">:</span>
        <span class="na">role</span><span class="pi">:</span> <span class="s">master</span>

    <span class="c1"># List of the commands to periodically execute. Their output will be used as node labels.</span>
    <span class="c1"># See "Labeling Nodes" section below for more information.</span>
    <span class="na">commands</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">arch</span>             <span class="c1"># this command will add a label like 'arch=x86_64' to a node</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">uname</span><span class="pi">,</span> <span class="nv">-p</span><span class="pi">]</span>
      <span class="na">period</span><span class="pi">:</span> <span class="s">1h0m0s</span>

    <span class="c1"># enables reading ~/.tsh/environment before creating a session. by default</span>
    <span class="c1"># set to false, can be set true here or as a command line flag.</span>
    <span class="na">permit_user_env</span><span class="pi">:</span> <span class="no">false</span>

<span class="c1"># This section configures the 'proxy servie'</span>
<span class="na">proxy_service</span><span class="pi">:</span>
    <span class="c1"># Turns 'proxy' role on. Default is 'yes'</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="s">yes</span>

    <span class="c1"># SSH forwarding/proxy address. Command line (CLI) clients always begin their</span>
    <span class="c1"># SSH sessions by connecting to this port</span>
    <span class="na">listen_addr</span><span class="pi">:</span> <span class="s">172.16.0.80:3023</span>

    <span class="c1"># Reverse tunnel listening address. An auth server (CA) can establish an</span>
    <span class="c1"># outbound (from behind the firewall) connection to this address.</span>
    <span class="c1"># This will allow users of the outside CA to connect to behind-the-firewall</span>
    <span class="c1"># nodes.</span>
    <span class="na">tunnel_listen_addr</span><span class="pi">:</span> <span class="s">172.16.0.80:3024</span>

    <span class="c1"># The HTTPS listen address to serve the Web UI and also to authenticate the</span>
    <span class="c1"># command line (CLI) users via password+HOTP</span>
    <span class="na">web_listen_addr</span><span class="pi">:</span> <span class="s">172.16.0.80:3080</span>

    <span class="c1"># TLS certificate for the HTTPS connection. Configuring these properly is</span>
    <span class="c1"># critical for Teleport security.</span>
    <span class="c1">#https_key_file: /var/lib/teleport/webproxy_key.pem</span>
    <span class="c1">#https_cert_file: /var/lib/teleport/webproxy_cert.pem</span>
</code></pre></div></div>

<p>配置完成后直接启动即可</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl <span class="nb">enable </span>teleport
systemctl start teleport
</code></pre></div></div>

<h3 id="五将内网集群链接至公网">五、将内网集群链接至公网</h3>

<p>上文已经讲过，Teleport 通过公网链接内网主机的方式是让内网集群向公网打通一条 ssh 隧道，然后再进行通讯；具体配置如下</p>

<h4 id="51公网-master-开启授信集群">5.1、公网 Master 开启授信集群</h4>

<p>在公网 Master 增加 Token 配置，以允许持有该 Token 的其他内网集群连接到此，修改 <code class="highlighter-rouge">/etc/teleport/teleport.yaml</code> 增加一个 token 即可</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tokens:
    - <span class="s2">"proxy,node:jYektagNTmhjv9Dh"</span>
    - <span class="s2">"auth:jYektagNTmhjv9Dh"</span>
    - <span class="s2">"trusted_cluster:xiomwWcrKinFw4Vs"</span>
</code></pre></div></div>

<p>然后重启 Teleport</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart teleport
</code></pre></div></div>

<h4 id="52内网-master-链接公网-master">5.2、内网 Master 链接公网 Master</h4>

<p>当公网集群开启了允许其他集群链接后，内网集群只需要创建配置进行连接即可，创建配置(cluster.yaml)如下</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># cluster.yaml</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">trusted_cluster</span>
<span class="na">version</span><span class="pi">:</span> <span class="s">v2</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="c1"># the trusted cluster name MUST match the 'cluster_name' setting of the</span>
  <span class="c1"># cluster</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">local_cluster</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="c1"># this field allows to create tunnels that are disabled, but can be enabled later.</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="c1"># the token expected by the "main" cluster:</span>
  <span class="na">token</span><span class="pi">:</span> <span class="s">xiomwWcrKinFw4Vs</span>
  <span class="c1"># the address in 'host:port' form of the reverse tunnel listening port on the</span>
  <span class="c1"># "master" proxy server:</span>
  <span class="na">tunnel_addr</span><span class="pi">:</span> <span class="s">92.223.67.84:3024</span>
  <span class="c1"># the address in 'host:port' form of the web listening port on the</span>
  <span class="c1"># "master" proxy server:</span>
  <span class="na">web_proxy_addr</span><span class="pi">:</span> <span class="s">92.223.67.84:3080</span>
</code></pre></div></div>

<p>执行以下命令使内网集群通过 ssh 隧道连接到公网集群</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tctl <span class="nt">--config</span> /etc/teleport/teleport.yaml create /etc/teleport/cluster.yaml
</code></pre></div></div>

<p><strong>注意，如果在启动公网和内网集群时没有指定受信的证书( <code class="highlighter-rouge">https_cert_file</code>、<code class="highlighter-rouge">https_key_file</code> )，那么默认 Teleport 将会生成一个自签名证书，此时在 create 受信集群时将会产生如下错误:</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>the trusted cluster uses misconfigured HTTP/TLS certificate
</code></pre></div></div>

<p>此时需要在 <strong>待添加集群(内网)</strong> 启动时增加 <code class="highlighter-rouge">--insecure</code> 参数，即 Systemd 配置修改如下</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Teleport SSH Service
<span class="nv">After</span><span class="o">=</span>network.target

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>simple
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/teleport start <span class="nt">--insecure</span> <span class="nt">-c</span> /etc/teleport/teleport.yaml

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<p>然后再进行 create 就不会报错</p>

<h3 id="六添加其他节点">六、添加其他节点</h3>

<p>两台节点打通后，此时如果有其他机器则可以将其加入到对应集群中，以下以另一台内网机器为例</p>

<p>由于在主节点 <code class="highlighter-rouge">auth_service</code> 中已经预先指定了一个 static Token 用于其他节点加入( <code class="highlighter-rouge">proxy,node:jYektagNTmhjv9Dh</code> )，所以其他节点只需要使用这个 Token 加入即可，在另一台内网主机上修改 Systemd 配置如下，然后启动即可</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Teleport SSH Service
<span class="nv">After</span><span class="o">=</span>network.target

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>simple
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/teleport start <span class="nt">--roles</span><span class="o">=</span>node,proxy <span class="se">\</span>
                                        <span class="nt">--token</span><span class="o">=</span>jYektagNTmhjv9Dh <span class="se">\</span>
                                        <span class="nt">--auth-server</span><span class="o">=</span>172.16.0.80

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<p>此时在内网的 Master 上可以查看到 Node 已经加入</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test1.node ➜ tctl <span class="nt">--config</span> /etc/teleport/teleport.yaml nodes <span class="nb">ls
</span>Hostname    UUID                                 Address          Labels
<span class="nt">-----------</span> <span class="nt">------------------------------------</span> <span class="nt">----------------</span> <span class="nt">-----------------------</span>
test2.node  abc786fe-9a60-4480-80f7-8edc20710e58 172.16.0.81:3022
mritd.test1 be9080fb-bdba-4823-9fb6-294e0b0dcce3 172.16.0.80:3022 <span class="nv">arch</span><span class="o">=</span>x86_64,role<span class="o">=</span>master
</code></pre></div></div>

<h3 id="七连接测试">七、连接测试</h3>

<h4 id="71web-测试">7.1、Web 测试</h4>

<p>Teleport 支持 Web 页面访问，直接访问 <code class="highlighter-rouge">https://公网IP:3080</code>，然后登陆即可，登陆后如下</p>

<p><img src="https://mritd.b0.upaiyun.com/markdown/9yf6k.png" alt="Web login" /></p>

<p>通过 Cluster 选项可以切换不同集群，点击后面的用户名可以选择不同用户登录到不同主机(用户授权在添加用户时控制)，登陆成功后如下</p>

<p><img src="https://mritd.b0.upaiyun.com/markdown/m7hz5.png" alt="Login Success" /></p>

<p>通过 Teleport 进行的所有操作可以通过审计菜单进行操作回放</p>

<p><img src="https://mritd.b0.upaiyun.com/markdown/c8a74.png" alt="Audit" /></p>

<h4 id="72命令行测试">7.2、命令行测试</h4>

<p>类 Uninx 系统下我们还是习惯使用终端登录，终端登录需要借助 Teleport 的命令行工具 <code class="highlighter-rouge">tsh</code>，<code class="highlighter-rouge">tsh</code> 在下载的 release 压缩版中已经有了，具体使用文档请自行 help 和参考官方文档，以下为简单的使用示例</p>

<ul>
  <li>登录跳板机: 短时间内只需要登录一次即可，登录时需要输入密码及 OTP 口令</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">TELEPORT_PROXY</span><span class="o">=</span>92.223.67.84
<span class="nb">export </span><span class="nv">TELEPORT_USER</span><span class="o">=</span>mritd
tsh login <span class="nt">--insecure</span>
</code></pre></div></div>

<ul>
  <li>登录主机: 完成上一步 login 后就可以免密码登录任意主机</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cluster 名字是上面设置的，在 web 界面也能看到</span>
tsh ssh <span class="nt">--cluster</span> nat root@test2.node
</code></pre></div></div>

<ul>
  <li>复制文件: <strong>复制文件时不显示进度，并非卡死</strong></li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tsh scp <span class="nt">--cluster</span> nat teleport-v2.3.5-linux-amd64-bin.tar.gz root@test2.node:/

-&gt; teleport-v2.3.5-linux-amd64-bin.tar.gz <span class="o">(</span>16797035<span class="o">)</span>
</code></pre></div></div>

<p>转载请注明出处，本文采用 <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> 协议授权</p>

    </article>
    <div class="share">
      <div class="share-component"></div>

    </div>
    <div class="comment">
      
    
        
        <!-- Disqus Protection, see https://github.com/mzlogin/mzlogin.github.io/issues/2 -->
        
            <div id="disqus_thread"></div>
            <script>
                var disqus_config = function () {
                    this.page.url = 'https://mritd.me/2017/11/09/set-up-teleport/';
                    this.page.identifier = '/2017/11/09/set-up-teleport/';
                    this.page.title = 'Teleport 跳板机部署';
                };
                (function() { // DON'T EDIT BELOW THIS LINE
                    var d = document, s = d.createElement('script');
                    s.type = 'text/javascript';
                    s.async = true;
                    var shortname = 'mritd';
                    s.src = '//' + shortname + '.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
        
    


    </div>
  </div>
  <div class="column one-fourth">
    
<h3>Search</h3>
<div id="site_search">
    <input type="text" id="search_box" placeholder="Search">
    <button class="btn btn-default" id="site_search_do"><span class="octicon octicon-search"></span></button>
</div>

<ul id="search_results"></ul>

<link rel="stylesheet" type="text/css" href="https://mritd.b0.upaiyun.com/assets/css/modules/sidebar-search.css">
<script src="https://mritd.b0.upaiyun.com/assets/js/lunr.min.js"></script>
<script src="https://mritd.b0.upaiyun.com/assets/js/search.js"></script>

    
<h3>Post Directory</h3>
<div id="post-directory-module" class="mobile-hidden">
  <section class="post-directory">
  <!-- Links that trigger the jumping -->
  <!-- Added by javascript below -->
  <dl></dl>
  </section>
</div>

<script src="https://mritd.b0.upaiyun.com/assets/js/jquery.toc.js"></script>

  </div>
</div>
</section>
<!-- /section.content -->

    <footer class="container">
        <div class="site-footer" role="contentinfo">
            <div class="copyright left mobile-block">
                    © 2017
                    <span title="漠然">漠然</span>
                    <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
            </div>

            <ul class="site-footer-links right mobile-hidden">
                <li>
                    <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a>
                </li>
                <li>
                    <a href="javascript:window.scrollTo(0,0)" >TOP</a>
                </li>
            </ul>
            <a href="http://github.com/mritd/mritd.github.io" target="_blank" aria-label="view source code">
                <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
            </a>
            <ul class="site-footer-links mobile-hidden">
                
                <li>
                    <a href="/" title="首页" target="">首页</a>
                </li>
                
                <li>
                    <a href="/categories/" title="分类" target="">分类</a>
                </li>
                
                <li>
                    <a href="/wiki/" title="维基" target="">维基</a>
                </li>
                
                <li>
                    <a href="/open-source/" title="开源" target="">开源</a>
                </li>
                
                <li>
                    <a href="/links/" title="链接" target="">链接</a>
                </li>
                
                <li>
                    <a href="/about/" title="关于" target="">关于</a>
                </li>
                
                <li><a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li>
            </ul>

        </div>
    </footer>
    <!-- / footer -->
    <script src="https://mritd.b0.upaiyun.com/assets/vendor/share.js/dist/js/share.min.js"></script>
    <script src="https://mritd.b0.upaiyun.com/assets/js/geopattern.js"></script>
    <script src="https://mritd.b0.upaiyun.com/assets/js/prism.js"></script>
    <link rel="stylesheet" href="https://mritd.b0.upaiyun.com/assets/css/globals/prism.css">
    <script>
      jQuery(document).ready(function($) {
        // geopattern
        $('.geopattern').each(function(){
          $(this).geopattern($(this).data('pattern-id'));
        });
       // hljs.initHighlightingOnLoad();
      });
    </script>
    
    <div style="display:none">
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-82387173-1', 'auto');
        ga('send', 'pageview');

      </script>
    </div>
    
</body>
</html>
