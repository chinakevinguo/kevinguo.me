<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.4.3">Jekyll</generator><link href="https://kevinguo.me/feed.xml" rel="self" type="application/atom+xml" /><link href="https://kevinguo.me/" rel="alternate" type="text/html" /><updated>2017-09-12T15:37:51+08:00</updated><id>https://kevinguo.me/</id><title type="html">KevinGuo</title><subtitle>KevinGuo's blog</subtitle><author><name>KevinGuo</name></author><entry><title type="html">kubernetes ceph 笔记 1</title><link href="https://kevinguo.me/2017/09/06/kubernetes-ceph-1/" rel="alternate" type="text/html" title="kubernetes ceph 笔记 1" /><published>2017-09-06T00:00:00+08:00</published><updated>2017-09-06T00:00:00+08:00</updated><id>https://kevinguo.me/2017/09/06/kubernetes-ceph-1</id><content type="html" xml:base="https://kevinguo.me/2017/09/06/kubernetes-ceph-1/">&lt;blockquote&gt;
  &lt;p&gt;该教程主要是为statefulset有状态服务集群提供持久化存储提供基础，在讲statefulset之前，我们先搭建我们的ceph集群
；具备了极好的可靠性、统一性；经过近几年的发展，ceph开辟了一个全新的数据存储途径。ceph具备了企业级存储的分布式、可大规模扩展、没有当节点故障等特点，越来越受人们的青睐。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;简介&quot;&gt;简介&lt;/h3&gt;

&lt;p&gt;Ceph是一个符合POSIX、开源的分布式存储系统，不论你是想提供&lt;code class=&quot;highlighter-rouge&quot;&gt;ceph 对象存储&lt;/code&gt;或&lt;code class=&quot;highlighter-rouge&quot;&gt;ceph 块设备&lt;/code&gt;，还是想部署一个&lt;code class=&quot;highlighter-rouge&quot;&gt;ceph文件系统&lt;/code&gt;或者把ceph作为他用，所有 &lt;code class=&quot;highlighter-rouge&quot;&gt;Ceph存储集群&lt;/code&gt; 的部署都始于部署一个个 &lt;code class=&quot;highlighter-rouge&quot;&gt;ceph节点&lt;/code&gt;、&lt;code class=&quot;highlighter-rouge&quot;&gt;网络&lt;/code&gt;和&lt;code class=&quot;highlighter-rouge&quot;&gt;ceph存储集群&lt;/code&gt;，ceph 存储集群至少需要一个 &lt;code class=&quot;highlighter-rouge&quot;&gt;ceph monitor&lt;/code&gt;和两个&lt;code class=&quot;highlighter-rouge&quot;&gt;osd守护进程&lt;/code&gt;。而运行&lt;code class=&quot;highlighter-rouge&quot;&gt;ceph文件系统客户端&lt;/code&gt;，则必须需要MDS(元数据服务器)。&lt;/p&gt;

&lt;p&gt;基础组件:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Ceph OSDs: Ceph OSD 守护进程的功能是存储数据，处理数据的复制、恢复、回填、再均衡，并通过检查其他OSD守护进程的心跳来向 Ceph Monitors 提供一些监控信息。当Ceph 存储集群设定为有2个副本时，至少需要2个OSD守护进程，集群才能到到&lt;code class=&quot;highlighter-rouge&quot;&gt;active+clean&lt;/code&gt;状态(Ceph 默认有3个副本，你可以调整&lt;code class=&quot;highlighter-rouge&quot;&gt;osd poll default size&lt;/code&gt;)&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Ceph Monitors: Ceph Monitor基于PAXOS算法维护着 展示集群状态的各种图表，包括监视器图、OSD图、PG图、CRUSH图。Ceph 保存着发生在Monitors、OSD和PG上的每一次状态变更的历史信息(称为 epoch)&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;MDSs：Ceph MDS为 Ceph 文件系统存储元数据(也就是说，Ceph块设备和Ceph对象存储是不是用MDS)。MDS使得POSIX文件系统的用户们，可以在部队Ceph存储集群造成负担的前提下，执行诸如 &lt;code class=&quot;highlighter-rouge&quot;&gt;ls&lt;/code&gt;、&lt;code class=&quot;highlighter-rouge&quot;&gt;find&lt;/code&gt;等基本命令&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;下图展示了Ceph的基础架构图&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/ceph-soft-topu.png&quot; alt=&quot;ceph-topu&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;1基础存储系统rados&quot;&gt;1.基础存储系统RADOS&lt;/h4&gt;

&lt;p&gt;RADOS (Reliable Autonomic Distributed Object Store),这一层本身就是一个完整的对象存储系统，包括Ceph的基础服务(OSD,MON,MDS)，所有存储在ceph中的用户数据实际上最终都是由这一层来存储的。而Ceph的高可用，高扩展性，高自动化等特性本质上也是有这一层所提供的，因此，RADOS是ceph的核心精华部分。&lt;/p&gt;

&lt;h4 id=&quot;2基础库librados&quot;&gt;2.基础库LibRados&lt;/h4&gt;

&lt;p&gt;这一层是对RADOS进行抽象和封装，并向上层提供不同的API，这样上层的RBD、RGW、CephFS才能访问RADOS，RADOS所提供的原生librados API包括C和C++两种。&lt;/p&gt;

&lt;h4 id=&quot;3高层存储应用接口&quot;&gt;3.高层存储应用接口&lt;/h4&gt;

&lt;p&gt;这一层包含了RGW、RBD和CephFS这几个部分，其作用是在librados库的基础上提供抽象层次更高，更便于应用和用户端使用的上层接口。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;RGW: 是一个提供与S3和Swift兼容的RESTful API的gateway，以供对应的对象存储应用开发使用。通过RGW可以将RADOS响应转化为HTTP响应，同样也可以将外部的HTTP响应状花为RADOS调用。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;RBD：提供一个标准的块设备接口服务。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;CephFS: 提供一个POSIX兼容的分布式文件系统。&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;4client层&quot;&gt;4.client层&lt;/h4&gt;

&lt;p&gt;这一层其实就是不同场景下对于ceph各个应用接口的各种应用方式，例如基于librados直接开发的对象存储应用，基于RGW开发的对象存储应用，基于RBD实现的云硬盘等等。&lt;/p&gt;

&lt;h4 id=&quot;5其他&quot;&gt;5.其他&lt;/h4&gt;

&lt;p&gt;一个Cluster逻辑上可以划分为多个Pool，一个Pool由若干个逻辑PG组成。&lt;/p&gt;

&lt;p&gt;一个文件会被切分为多个Object，每个Object会被映射到一个PG，每个PG 会根据CRUSH算法映射到一组OSD，其中第一个OSD（Primary OSD）为主，其余是备，OSD间通过心跳来互相监控存活状态。&lt;/p&gt;

&lt;p&gt;CRUSH： CRUSH是ceph使用的数据分布算法，类似一致性哈希，让数据分配到预期的地方。&lt;/p&gt;

&lt;h3 id=&quot;一快速安装&quot;&gt;一.快速安装&lt;/h3&gt;

&lt;h4 id=&quot;11-安装前准备&quot;&gt;1.1 安装前准备&lt;/h4&gt;

&lt;p&gt;所需机器如下&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;IP&lt;/th&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;HostName&lt;/th&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;OS&lt;/th&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;role&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;172.30.33.31&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;deploy-node&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;centos7.3.1611&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;deploy node&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;172.30.33.90&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;k8s-master01&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;centos7.3.1611&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;monitor osd node1&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;172.30.33.91&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;k8s-master02&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;centos7.3.1611&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;osd node2&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;172.30.33.92&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;k8s-master03&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;centos7.3.1611&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;osd node3&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h5 id=&quot;在管理节点上操作&quot;&gt;在管理节点上操作&lt;/h5&gt;

&lt;p&gt;1.执行如下命令&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo yum install -y yum-utils &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sudo yum-config-manager --add-repo https://dl.fedoraproject.org/pub/epel/7/x86_64/ &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sudo yum install --nogpgcheck -y epel-release &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sudo rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sudo rm /etc/yum.repos.d/dl.fedoraproject.org&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;2.将软件包源加入软件仓库&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;vim /etc/yum.repos.d/ceph.repo

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;ceph]
&lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;ceph
&lt;span class=&quot;nv&quot;&gt;baseurl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://mirrors.163.com/ceph/rpm-jewel/el7/x86_64/
&lt;span class=&quot;nv&quot;&gt;gpgcheck&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;ceph-noarch]
&lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;cephnoarch
&lt;span class=&quot;nv&quot;&gt;baseurl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://mirrors.163.com/ceph/rpm-jewel/el7/noarch/
&lt;span class=&quot;nv&quot;&gt;gpgcheck&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;3.更新并安装&lt;code class=&quot;highlighter-rouge&quot;&gt;ceph-deploy&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo yum update &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sudo yum install ceph-deploy
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;4.配置从部署机器到所有其他节点的免密钥登录，具体参考&lt;a href=&quot;https://kevinguo.me/2017/07/06/ansible-client/&quot;&gt;这里&lt;/a&gt;&lt;/p&gt;

&lt;h5 id=&quot;在节点上操作&quot;&gt;在节点上操作&lt;/h5&gt;

&lt;p&gt;1.安装epel源&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;yum install yum-plugin-priorities
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;yum install epel-release -y
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;2.校对时间，由于ceph使用Paxos算法保证数据一致性，所以安装前要先保证各个节点的时间同步&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo yum install ntp ntpdate ntp-doc

&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ntpdate 0.cn.pool.ntp.org
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;3.开放所需端口或关闭防火墙&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;system stop firewalld
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo firewall-cmd --zone&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;public --add-port&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;6789/tcp --permanent
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;4.关闭selinux&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo setenforce 0
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;12-创建集群&quot;&gt;1.2 创建集群&lt;/h4&gt;

&lt;p&gt;1.由于ceph-deploy工具部署集群前需要创建一些集群配置信息，其保存在&lt;code class=&quot;highlighter-rouge&quot;&gt;ceph.conf&lt;/code&gt;文件中，这个文件将来会被复制到每个节点的 &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/ceph/ceph.conf&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 创建集群配置目录&lt;/span&gt;
mkdir ceph-cluster &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;ceph-cluster
&lt;span class=&quot;c&quot;&gt;# 创建 monitor-node&lt;/span&gt;
ceph-deploy new k8s-master01
&lt;span class=&quot;c&quot;&gt;# 追加 OSD 副本数量(测试虚拟机总共有3台)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;osd pool default size = 3&quot;&lt;/span&gt; &amp;gt;&amp;gt; ceph.conf
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;2.创建集群使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;ceph-deploy&lt;/code&gt;工具在部署节点上执行即可&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 安装ceph&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph-deploy install k8s-master01 k8s-master02 k8s-master03
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;注意：在部署节点部署的时候，可能会因为网络原因导致无法安装ceph和ceph-radosgw，这时候，我们在各个节点上手动安装一下&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 添加ceph 163源&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;ceph]
&lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;ceph
&lt;span class=&quot;nv&quot;&gt;baseurl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://mirrors.163.com/ceph/rpm-jewel/el7/x86_64/
&lt;span class=&quot;nv&quot;&gt;gpgcheck&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;ceph-noarch]
&lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;cephnoarch
&lt;span class=&quot;nv&quot;&gt;baseurl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://mirrors.163.com/ceph/rpm-jewel/el7/noarch/
&lt;span class=&quot;nv&quot;&gt;gpgcheck&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0

&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;yum install ceph ceph-radosgw -y
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;3.初始化monitor node 和密钥文件&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph-deploy mon create-initial
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;4.在osd节点上创建一个目录作为 osd 存储，并修改其权限,千万别创建在&lt;code class=&quot;highlighter-rouge&quot;&gt;/usr/local&lt;/code&gt;目录下，否则，你的osd可能会无法挂载&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ssh k8s-master01
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo mkdir /data/osd1
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;chown -R ceph:ceph osd1
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;

&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ssh k8s-master2
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo mkdir /data/osd2
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;chown -R ceph:ceph osd2
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;

&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ssh k8s-master3
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo mkdir /data/osd3
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;chown -R ceph:ceph osd3
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;5.然后，在管理节点上初始化 osd&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph-deploy osd prepare k8s-master01:/data/osd1 k8s-master02:/data/osd2 k8s-master03:/data/osd3
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;6.最后，在管理节点上激活 osd&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph-deploy osd activate k8s-master01:/data/osd1 k8s-master02:/data/osd2 k8s-master03:/data/osd3
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;7.在管理节点上部署 ceph cli 工具和密钥文件&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph-deploy admin k8s-master01 k8s-master02 k8s-master03
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;8.确保你对 &lt;code class=&quot;highlighter-rouge&quot;&gt;ceph.client.admin.keyring&lt;/code&gt;有正确的操作权限，在每个节点上执行&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo chmod +r /etc/ceph/ceph.client.admin.keyring
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;9.最后，检查集群的健康状态&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph health
HEALTH_OK

&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph osd tree
ID WEIGHT  TYPE NAME             UP/DOWN REWEIGHT PRIMARY-AFFINITY
-1 0.14067 root default                                            
-2 0.04689     host k8s-master01                                   
 0 0.04689         osd.0              up  1.00000          1.00000
-3 0.04689     host k8s-master02                                   
 1 0.04689         osd.1              up  1.00000          1.00000
-4 0.04689     host k8s-master03                                   
 2 0.04689         osd.2              up  1.00000          1.00000
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;我们看到状态是OK的，而且每个节点上的osd的状态都是up的&lt;/p&gt;

&lt;p&gt;如果在某些地方碰到麻烦，想从头再来，可以用下列命令来清楚配置：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph-deploy purgedata &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;ceph-node&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[{&lt;/span&gt;ceph-node&lt;span class=&quot;o&quot;&gt;}]&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph-deploy forgetkeys
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;用下列命令可以连Ceph安装包一起清除：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph-deploy purge &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;ceph-node&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[{&lt;/span&gt;ceph-node&lt;span class=&quot;o&quot;&gt;}]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;二操作集群&quot;&gt;二.操作集群&lt;/h3&gt;

&lt;h4 id=&quot;21-基础操作&quot;&gt;2.1 基础操作&lt;/h4&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 创建MDS&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph-deploy mds create &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;ceph-node&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 创建RGW&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph-deploy rgw create &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;ceph-node&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 添加mon&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;public network = 172.30.33.0/24&quot;&lt;/span&gt; &amp;gt;&amp;gt; ceph.conf
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph-deploy mon add &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;ceph-node&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 查看仲裁&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph quorum_status --format json-pretty
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;22-对象存储测试&quot;&gt;2.2 对象存储测试&lt;/h4&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 创建pool&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# rados mkpool {pool-name}&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;rados mkpool &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-pool

&lt;span class=&quot;c&quot;&gt;# 创建测试文件&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;dd &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/zero &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;testfile &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1G &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1

&lt;span class=&quot;c&quot;&gt;# 创建一个对象(这时候也将对象放入了pool中)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# rados put {object-name} {file-path} --pool={pool-name}&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;rados put &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-object testfile --pool&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-pool

&lt;span class=&quot;c&quot;&gt;# 检查存储池，确认ceph存储了此对象&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;rados -p &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-pool ls

&lt;span class=&quot;c&quot;&gt;# 定位对象，会输出对象位置&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph osd map &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-pool &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-object
osdmap e42 pool &lt;span class=&quot;s1&quot;&gt;'test-pool'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;3&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; object &lt;span class=&quot;s1&quot;&gt;'test-file'&lt;/span&gt; -&amp;gt; pg 3.b79653d4 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;3.4&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; -&amp;gt; up &lt;span class=&quot;o&quot;&gt;([&lt;/span&gt;1,5,2,3,4], p1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; acting &lt;span class=&quot;o&quot;&gt;([&lt;/span&gt;1,5,2,3,4], p1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 删除对象&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;rados -p data rm &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-object

&lt;span class=&quot;c&quot;&gt;# 删除存储池&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;rados rmpool &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-pool &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-pool --yes-i-really-really-mean-it
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;随着集群的运行，对象的位置可能会动态改变。Ceph有动态均衡机制，无需手动干预即可完成。&lt;/p&gt;

&lt;h4 id=&quot;23-块存储测试&quot;&gt;2.3 块存储测试&lt;/h4&gt;

&lt;p&gt;&lt;strong&gt;官方建议RBD和OSD最好不要在同一台物理机上(除非它们都是VM)&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;1.确认你使用了合适的内核版本，详情&lt;a href=&quot;http://docs.ceph.com/docs/master/start/os-recommendations/&quot;&gt;参见&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;lab_release -a
uname -a
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;2.在管理节点上用 &lt;code class=&quot;highlighter-rouge&quot;&gt;ceph-deploy&lt;/code&gt;安装ceph&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ceph-deploy install &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;rbd-client&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;3.在管理节点上部署ceph cli工具和密钥&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ceph-deploy admin &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;rbd-client&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;4.在rbd节点上创建块设备image&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rbd create &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-block --size 4096
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;5.映射image到块设备&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rbd map &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-block --name client.admin
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;在上面的map映射操作时，会出现如下报错&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;rbd map &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-block --name client.admin
rbd: sysfs write failed
RBD image feature &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;mismatch. You can disable features unsupported by the kernel with &lt;span class=&quot;s2&quot;&gt;&quot;rbd feature disable&quot;&lt;/span&gt;.
In some cases useful info is found &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;syslog - try &lt;span class=&quot;s2&quot;&gt;&quot;dmesg | tail&quot;&lt;/span&gt; or so.
rbd: map failed: &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;6&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; No such device or address
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;大致意思是说features不匹配，可以通过disable features关掉一些特性来让内核支持。这是因为在Ceph高本本进行 map image时，默认ceph在创建image(上文test-block)时，会增加很多features，这些features需要内核支持，centos7上的支持有限，所以，我们需要关掉一些&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;我们可以用 &lt;code class=&quot;highlighter-rouge&quot;&gt;rbd info data&lt;/code&gt; 看看创建的image目前有哪些features&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;rbd info &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-block
rbd image &lt;span class=&quot;s1&quot;&gt;'test-block'&lt;/span&gt;:
	size 4096 MB &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;1024 objects
	order 22 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;4096 kB objects&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
	block_name_prefix: rbd_data.10bb238e1f29
	format: 2
	features: layering, exclusive-lock, object-map, fast-diff, deep-flatten
	flags:
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;在features中，我们可以看到默认开启了很多：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;layering 支持分层&lt;/li&gt;
  &lt;li&gt;exclusive-lock 支持独占锁&lt;/li&gt;
  &lt;li&gt;object-map 支持对象映射(依赖exclusive-lock)&lt;/li&gt;
  &lt;li&gt;fast-diff 快速计算差异(依赖object-map)&lt;/li&gt;
  &lt;li&gt;deep-flatten 支持快照扁平化操作&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;而实际上在CentOS7的3.10内核中只支持layering，所以我们需要手动关闭一些features，然后重新map；如果想要一劳永逸，可以在 ceph.conf 中加入 rbd_default_features = 1 来设置默认 features(数值仅是 layering 对应的 bit 码所对应的整数值)&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;6.关闭不支持的特性之后重新map&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 关闭不支持的features&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;rbd feature disable &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-block exclusive-lock, object-map, fast-diff, deep-flatten

&lt;span class=&quot;c&quot;&gt;# 重新map&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;rbd map &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-block --name client.admin
/dev/rbd0
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;7.格式化之后挂载到系统目录&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 格式化&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;mkfs.xfs /dev/rbd0
meta-data&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/rbd0              &lt;span class=&quot;nv&quot;&gt;isize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;512    &lt;span class=&quot;nv&quot;&gt;agcount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;9, &lt;span class=&quot;nv&quot;&gt;agsize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;130048 blks
         &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;                       &lt;span class=&quot;nv&quot;&gt;sectsz&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;512   &lt;span class=&quot;nv&quot;&gt;attr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2, &lt;span class=&quot;nv&quot;&gt;projid32bit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
         &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;                       &lt;span class=&quot;nv&quot;&gt;crc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1        &lt;span class=&quot;nv&quot;&gt;finobt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0, &lt;span class=&quot;nv&quot;&gt;sparse&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
data     &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;                       &lt;span class=&quot;nv&quot;&gt;bsize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4096   &lt;span class=&quot;nv&quot;&gt;blocks&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1048576, &lt;span class=&quot;nv&quot;&gt;imaxpct&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;25
         &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;                       &lt;span class=&quot;nv&quot;&gt;sunit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1024   &lt;span class=&quot;nv&quot;&gt;swidth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1024 blks
naming   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;version 2              &lt;span class=&quot;nv&quot;&gt;bsize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4096   ascii-ci&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0 &lt;span class=&quot;nv&quot;&gt;ftype&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
log      &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;internal log           &lt;span class=&quot;nv&quot;&gt;bsize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4096   &lt;span class=&quot;nv&quot;&gt;blocks&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2560, &lt;span class=&quot;nv&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2
         &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;                       &lt;span class=&quot;nv&quot;&gt;sectsz&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;512   &lt;span class=&quot;nv&quot;&gt;sunit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;8 blks, lazy-count&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
realtime &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;none                   &lt;span class=&quot;nv&quot;&gt;extsz&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4096   &lt;span class=&quot;nv&quot;&gt;blocks&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0, &lt;span class=&quot;nv&quot;&gt;rtextents&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0

&lt;span class=&quot;c&quot;&gt;# 挂载&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;mkdir &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-block
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;mount /dev/rbd0 &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-block

&lt;span class=&quot;c&quot;&gt;# 写入测试&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;dd &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/zero &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-block/test-file &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1G &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
1+0 records &lt;span class=&quot;k&quot;&gt;in
&lt;/span&gt;1+0 records out
1073741824 bytes &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1.1 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; copied, 2.96071 s, 363 MB/s

&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ls &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-block/
&lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-file
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;24-cephfs-测试&quot;&gt;2.4 CephFS 测试&lt;/h4&gt;

&lt;p&gt;1.创建MDS&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph-deploy mds create k8s-node01 k8s-node02 k8s-registry
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;2.创建pool和fs，创建pool需要指定PG数量&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ceph osd pool create cephfs_data 32
ceph osd pool create cephfs_metadata 32
ceph fs new &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-fs cephfs_metadata cephfs_data
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;PG 概念：&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;当Ceph集群接受到存储请求时，ceph会将一个文件会切分为多个Object，每个Object会被映射到一个PG，每个PG 会根据CRUSH算法映射到一组OSD(根据副本数)；一般来说增加PG的数量能降低OSD负载，一般每个OSD大约分配50～100PG，关于PG数量指定，一般遵循以下公式&lt;/p&gt;
  &lt;ul&gt;
    &lt;li&gt;集群PG总数 = (OSD总数 * 100)/数据最大副本数&lt;/li&gt;
    &lt;li&gt;单个存储池PG数 = (OSD总数 * 100)/数据最大副本数/存储池数&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;注意：PG的最终结果应当以最接近以上计算公式的2的N次幂(向上取值)；如我的虚拟机环境的每个存储池 PG数 = 6(OSD) * 100 / 5(副本数) / 4（4个存储池）= 30，向上取2的N次幂为32(即，2的5次方=32，最接近30)&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;3.挂载CephFS有两种方式，一种是使用内核驱动挂载，一种是使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;ceph-fuse&lt;/code&gt;用户空间挂载&lt;/p&gt;

&lt;p&gt;内核挂载需要提取ceph管理key，方式如下：&lt;/p&gt;

&lt;p&gt;在密钥文件中找到与某用户对于的密钥&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;cat /etc/ceph/ceph.client.admin.keyring
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;client.admin]
	key &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;AQBferZZEKXFLxAAhlzElpm2MhhbBGB4TnNVkA&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;==&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;复制密钥到文件中保存，并确保其权限&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;AQBferZZEKXFLxAAhlzElpm2MhhbBGB4TnNVkA==&quot;&lt;/span&gt; &amp;gt; ceph-key
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;创建目录挂载&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mkdir &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-fs
mount -t ceph 172.30.33.90:6789:/ /root/test-fs -o &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;admin,secretfile&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;ceph-key

&lt;span class=&quot;c&quot;&gt;#写入数据测试&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;dd &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/zero &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-fs/test-fs &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1G &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
1+0 records &lt;span class=&quot;k&quot;&gt;in
&lt;/span&gt;1+0 records out
1073741824 bytes &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1.1 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; copied, 2.77355 s, 387 MB/s
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ceph-fuse&lt;/code&gt;用户空间挂载的方式也比较简单，需要先安装ceph-fuse，同时也需要key&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 按照前面的步骤添加ceph源&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;vi /etc/yum.repos.d/ceph.repo
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;ceph]
&lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;ceph
&lt;span class=&quot;nv&quot;&gt;baseurl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://mirrors.163.com/ceph/rpm-jewel/el7/x86_64/
&lt;span class=&quot;nv&quot;&gt;gpgcheck&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;ceph-noarch]
&lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;cephnoarch
&lt;span class=&quot;nv&quot;&gt;baseurl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://mirrors.163.com/ceph/rpm-jewel/el7/noarch/
&lt;span class=&quot;nv&quot;&gt;gpgcheck&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0

&lt;span class=&quot;c&quot;&gt;# 安装ceph-fuse&lt;/span&gt;
yum install ceph-fuse -y

&lt;span class=&quot;c&quot;&gt;# 复制配置和ceph key到client端&lt;/span&gt;
sudo mkdir -p /etc/ceph
sudo scp root@172.30.33.91:/etc/ceph/ceph.conf /etc/ceph/ceph.conf
sudo scp root@172.30.33.91:/etc/ceph/ceph.client.admin.keyring /etc/ceph/ceph.client.admin.keyring

&lt;span class=&quot;c&quot;&gt;# 创建目录挂载&lt;/span&gt;
mkdir &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-fs-fuse
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo ceph-fuse -m 172.30.33.91:6789 &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-fs-fuse
ceph-fuse[60551]: starting ceph client
2017-09-12 14:47:24.137929 7f63d9719ec0 -1 init, newargv &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 0x7f63e51d4840 &lt;span class=&quot;nv&quot;&gt;newargc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;11
ceph-fuse[60551]: starting fuse

&lt;span class=&quot;c&quot;&gt;# 写入数据测试&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo dd &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/zero &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-fs-fuse/test-fs-fuse &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1G &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
1+0 records &lt;span class=&quot;k&quot;&gt;in
&lt;/span&gt;1+0 records out
1073741824 bytes &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1.1 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; copied, 10.5426 s, 102 MB/s

&lt;span class=&quot;c&quot;&gt;# 查看确认，发现我们上面通过内核挂载的文件也还在&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ls -lh
total 2.0G
-rw-r--r-- 1 root root 1.0G Sep 12 13:59 &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-fs
-rw-r--r-- 1 root root 1.0G Sep 12 14:49 &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-fs-fuse
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;25-ceph对象网关&quot;&gt;2.5 Ceph对象网关&lt;/h4&gt;

&lt;p&gt;1.对象网关创建&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 创建RGW&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;ceph-deploy rgw create k8s-node02
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;2.直接访问&lt;code class=&quot;highlighter-rouge&quot;&gt;http://ceph-node-ip:7480&lt;/code&gt;返回结果如下&lt;/p&gt;

&lt;div class=&quot;language-xml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;ListAllMyBucketsResult&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;xmlns=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;http://s3.amazonaws.com/doc/2006-03-01/&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;Owner&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;ID&amp;gt;&lt;/span&gt;anonymous&lt;span class=&quot;nt&quot;&gt;&amp;lt;/ID&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;DisplayName/&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/Owner&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;Buckets/&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/ListAllMyBucketsResult&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;这就说明网关OK了，但是因为没有读写环境，所以暂时测不了。&lt;/p&gt;

&lt;p&gt;本文参考了&lt;a href=&quot;http://docs.ceph.com/docs/master/start/&quot;&gt;ceph官方文档&lt;/a&gt;及漠然的&lt;a href=&quot;https://mritd.me/2017/05/27/ceph-note-1/&quot;&gt;ceph笔记(一)&lt;/a&gt;部分&lt;/p&gt;</content><author><name>KevinGuo</name></author><summary type="html">该教程主要是为statefulset有状态服务集群提供持久化存储提供基础，在讲statefulset之前，我们先搭建我们的ceph集群 ；具备了极好的可靠性、统一性；经过近几年的发展，ceph开辟了一个全新的数据存储途径。ceph具备了企业级存储的分布式、可大规模扩展、没有当节点故障等特点，越来越受人们的青睐。</summary></entry><entry><title type="html">kubernetes 入门</title><link href="https://kevinguo.me/2017/09/01/kubernetes-one-section/" rel="alternate" type="text/html" title="kubernetes 入门" /><published>2017-09-01T00:00:00+08:00</published><updated>2017-09-01T00:00:00+08:00</updated><id>https://kevinguo.me/2017/09/01/kubernetes-one-section</id><content type="html" xml:base="https://kevinguo.me/2017/09/01/kubernetes-one-section/">&lt;h2 id=&quot;入门概念&quot;&gt;入门概念&lt;/h2&gt;

&lt;p&gt;为什么要使用kubernetes&lt;/p&gt;

&lt;p&gt;1.新技术&lt;/p&gt;

&lt;p&gt;2.精简.只需要一个架构师专注于“服务组件”的提炼，几名开发工程师专注于代码开发，几名系统运维工程师负责kubernetes的部署和运维&lt;/p&gt;

&lt;p&gt;3.kubernetes使用微服务架构&lt;/p&gt;

&lt;p&gt;4.更方便迁移&lt;/p&gt;

&lt;p&gt;5.超强的横向扩容能力&lt;/p&gt;

&lt;h3 id=&quot;master&quot;&gt;master&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;kube-apiserver
提供HTTP RESET接口的关键服务进程，是kubernetes所有资源增删改查的唯一入口，也是集群控制的入口进程&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;kube-controller-manager
kubernetes里所有资源对象的自动化控制中心。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;kube-scheduler
kubernetes里所有资源的调度中心&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;kube-proxy
实现kubernetes service的通信与负载均衡机制的重要组件&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;kubelet
负责pod对应容器的创建，启停等任务，同时与Master节点密切协作，实现集群管理的基本功能&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;etcd
保存kubernetes里所有数据的存储&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;docker
运行kubernetes 里面的容器&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;node&quot;&gt;node&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;kube-proxy
实现kubernetes service的通信与负载均衡机制的重要组件&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;kubelet
负责pod对应容器的创建，启停等任务，同时与Master节点密切协作，实现集群管理的基本功能&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;docker
运行kubernetes 里面的容器&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;pod&quot;&gt;pod&lt;/h3&gt;

&lt;p&gt;一个pause容器和一组业务容器组成，是kubernetes里面最基本的单元。&lt;/p&gt;

&lt;h4 id=&quot;pause-容器&quot;&gt;pause 容器&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;既然pod是一组容器组成，那么如何来判断这个pod的状态呢，是其中一个容器死亡了，就算整个pod死亡了，还是说按照某种N/M的死亡率来算呢？kubernetes里面引入了一个不易死亡又和业务无关的&lt;code class=&quot;highlighter-rouge&quot;&gt;pause&lt;/code&gt;容器，以它的状态来表示整个pod的状态。&lt;/li&gt;
  &lt;li&gt;pod里面的多个容器共享&lt;code class=&quot;highlighter-rouge&quot;&gt;pause&lt;/code&gt;容器里面的网络和volumes。&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;普通pod和静态pod&quot;&gt;普通pod和静态pod&lt;/h4&gt;

&lt;p&gt;pod有两种类型：普通pod和静态pod&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;普通pod即是那些通过deployment，replicationcontroller，daemonset等部署的，这些pod一旦创建会被放入到etcd中，然后会被kubernetes master调度到某个node上，通过node上的kubelet进程实例化成一组相关的容器并启动起来。&lt;/li&gt;
  &lt;li&gt;静态pod是通过放在某个node上的一个具体的文件运行起来的。比如我们放在/etc/kubernetes/manifests下的某些静态文件。&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;endpoints&quot;&gt;endpoints&lt;/h4&gt;

&lt;p&gt;kubernetes中，每个pod都有一个属于他的IP。&lt;code class=&quot;highlighter-rouge&quot;&gt;Pod IP + 需要暴露出来的ContainerPort&lt;/code&gt; 就组成了endpoint
说到service的endpoint，这里就不得不说下targetPort，targetPort属性用来确定提供该服务的容器所暴露的端口号，如果你不指定targetPort，kubernetes默认使用你提供的port为targetPort&lt;/p&gt;

&lt;p&gt;所以他们的关系应该是如下：&lt;/p&gt;

&lt;p&gt;service 暴露一个提供服务的端口—&amp;gt;{pod IP+targetPort}(容器内部暴露出来提供服务的端口号)
                                         ||
                                     {endpoint}&lt;/p&gt;
&lt;h4 id=&quot;pod-volume&quot;&gt;pod volume&lt;/h4&gt;

&lt;p&gt;pod中的volume能够被pod中的多个容器访问。kubernetes中的volume与pod的生命周期相同，但与容器的生命周期不相关。
通常是声明一个volume，然后在容器中引用这个volume并mount到容器的某个目录上。
常用的类型有：&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;emptyDir&lt;/li&gt;
  &lt;li&gt;hostPath&lt;/li&gt;
  &lt;li&gt;Persistent Volume(GCE Persistent Disks、NFS、RBD、ISCSCI、AWS ElasticBlockStore、GlusterFS)，这就设计到分布式存储和外部存储的一些操作了，后续再讲吧&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ReplicationController&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;replicas&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;5&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# selector 如果不指定，默认和.spec.template.labels的值相同&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# 该处声明一个volume&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;datavol&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;emptyDir&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;{}&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;kubeguide/tomcat-app:v1&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;containerPort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;8080&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MYSQL_SERVICE_HOST&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;mysql-service'&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MYSQL_SERVICE_PORT&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;3306'&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# 该处进行引用并挂在到容器内部&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;volumeMounts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;datavol&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/mydata-data&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;pod-资源限制&quot;&gt;pod 资源限制&lt;/h4&gt;

&lt;p&gt;每个pod都能对其能使用的服务器上的资源来进行配额限制，当前能限制的只有CPU和Memory。在kubernetes里面，计算资源的限制主要是设定两个参数&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Limits 资源允许使用的最大值，不能超过&lt;/li&gt;
  &lt;li&gt;Requests 资源允许使用的最小值，最少必须满足这个需求&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;我们通常将&lt;code class=&quot;highlighter-rouge&quot;&gt;request&lt;/code&gt; 设置为容器平时正常运行时所需的资源，而将&lt;code class=&quot;highlighter-rouge&quot;&gt;Limits&lt;/code&gt;设置为容器峰值负载情况下的最大使用量&lt;/p&gt;

&lt;h4 id=&quot;label-and-label-selector&quot;&gt;label and label selector&lt;/h4&gt;

&lt;p&gt;label即标签，是Kubernetes系统中另一个核心概念。一个label是一个&lt;code class=&quot;highlighter-rouge&quot;&gt;key=value&lt;/code&gt;的键值对。label可以附加到各种资源对象上，如Node、Pod、RC、Service等，一个资源对象可以附加无数的label，同一个label也可以附加到无数的资源对象上。&lt;/p&gt;

&lt;p&gt;通过指定&lt;code class=&quot;highlighter-rouge&quot;&gt;label selector&lt;/code&gt;来查询和筛选某些拥有label的资源对象，常用到的两种表达式&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;等式 (key=value)&lt;/li&gt;
  &lt;li&gt;集合式 (key in values)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;label selector&lt;/code&gt;在kubernetes中常用的场景如下：&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;kub-controller-manager通过在RC上定义的&lt;code class=&quot;highlighter-rouge&quot;&gt;label selector&lt;/code&gt;来监控并控制POD的数量&lt;/li&gt;
  &lt;li&gt;kube-proxy 通过service上的&lt;code class=&quot;highlighter-rouge&quot;&gt;label selector&lt;/code&gt;来选择对应的pod，自动建立每个service到pod的路由请求，从而实现service的智能负载均衡&lt;/li&gt;
  &lt;li&gt;通过NodeSelector，将某些pod调度到指定的node上&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;注意：我们在指定&lt;code class=&quot;highlighter-rouge&quot;&gt;label selector&lt;/code&gt;时，需要和&lt;code class=&quot;highlighter-rouge&quot;&gt;.spec.template.metadata.labels&lt;/code&gt;下的值相同，如果不指定&lt;code class=&quot;highlighter-rouge&quot;&gt;label selector&lt;/code&gt;则默认保持和&lt;code class=&quot;highlighter-rouge&quot;&gt;.spec.template.metadata.labels&lt;/code&gt;的值相同&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&quot;replicationcontrollerrc&quot;&gt;ReplicationController(RC)&lt;/h3&gt;
&lt;p&gt;我们将上面那个例子的yaml文件直接拿来解析&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# api版本，类型，全局唯一名称，这是所有kubernetes yaml文件都需要的&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ReplicationController&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# 定义pod期望数量&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;replicas&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;5&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# 用于筛选目标的selector 如果不指定，默认和.spec.template.labels的值相同&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# 当Pod副本数和期望数不一致时，用于创建新pod的模板&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# 该处声明一个volume&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;datavol&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;emptyDir&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;{}&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;kubeguide/tomcat-app:v1&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;containerPort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;8080&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MYSQL_SERVICE_HOST&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;mysql-service'&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MYSQL_SERVICE_PORT&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;3306'&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# 该处进行引用并挂在到容器内部&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;volumeMounts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;datavol&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/mydata-data&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;我们可以通过命令的形式来动态缩放POD的数量&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubectl scale rc mysql --replicas&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2

&lt;span class=&quot;c&quot;&gt;# 删除pod&lt;/span&gt;
kubectl delete -f mysql-rc.yml
kubectl scale rc mysql --replicas&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;replicaset&quot;&gt;ReplicaSet&lt;/h3&gt;

&lt;p&gt;ReplicaSet和ReplicationController唯一的区别就是:ReplicaSet支持集合式的&lt;code class=&quot;highlighter-rouge&quot;&gt;label selector&lt;/code&gt;，我们平时很少单独使用&lt;code class=&quot;highlighter-rouge&quot;&gt;Replica Set&lt;/code&gt;，它主要是被&lt;code class=&quot;highlighter-rouge&quot;&gt;Deployment&lt;/code&gt;这个更高层的资源对象使用。&lt;/p&gt;

&lt;h3 id=&quot;deployment&quot;&gt;Deployment&lt;/h3&gt;
&lt;p&gt;Deployment在内部使用&lt;code class=&quot;highlighter-rouge&quot;&gt;Replica Set&lt;/code&gt;来实现目的，它管理着&lt;code class=&quot;highlighter-rouge&quot;&gt;Replica Set&lt;/code&gt;，而它管理&lt;code class=&quot;highlighter-rouge&quot;&gt;Replica Set&lt;/code&gt;的主要目的是为了支持版本回滚&lt;code class=&quot;highlighter-rouge&quot;&gt;Rollback&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;从下面命令所展示出来的命名规则我们不难发现，&lt;code class=&quot;highlighter-rouge&quot;&gt;Deployment&lt;/code&gt;创建的时候创建了&lt;code class=&quot;highlighter-rouge&quot;&gt;Replica Set&lt;/code&gt;，而&lt;code class=&quot;highlighter-rouge&quot;&gt;Replica Set&lt;/code&gt;创建了&lt;code class=&quot;highlighter-rouge&quot;&gt;Pod&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl get deployment -l k8s-app&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;kube-dns -n kube-system
NAME       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
kube-dns   2         2         2            2           6d

&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl get replicaset -l k8s-app&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;kube-dns -n kube-system
NAME                  DESIRED   CURRENT   READY     AGE
kube-dns-1446441763   2         2         2         6d

&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl get pods -l k8s-app&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;kube-dns -n kube-system
NAME                        READY     STATUS    RESTARTS   AGE
kube-dns-1446441763-0th37   3/3       Running   0          6d
kube-dns-1446441763-1w5gx   3/3       Running   0          6d
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;稍后，用实验来说明&lt;code class=&quot;highlighter-rouge&quot;&gt;Deployment&lt;/code&gt;在滚动升级中的作用&lt;/p&gt;

&lt;h3 id=&quot;pod滚动升级&quot;&gt;Pod滚动升级&lt;/h3&gt;

&lt;p&gt;在说Deployment的滚动升级之前，我们先来看看&lt;code class=&quot;highlighter-rouge&quot;&gt;ReplicationController&lt;/code&gt;的滚动升级&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ReplicationController&lt;/code&gt;的滚动升级和&lt;code class=&quot;highlighter-rouge&quot;&gt;Deployment&lt;/code&gt;的滚动升级有所不同，命令都不一样，通过执行&lt;code class=&quot;highlighter-rouge&quot;&gt;kubectl rolling-update&lt;/code&gt;来一键完成，该命令创建了一个新的RC，然后自动控制旧的RC中的POD副本数两逐渐减少到0，同时新RC中的POD数量从0逐步增加到目标值，最终实现POD的升级，滚动升级的配置文件必须满足如下三个条件：&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;metadata.name&lt;/code&gt;必须和旧RC文件中的不同&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;spec.selector&lt;/code&gt;至少有一个与旧RC的不同(&lt;strong&gt;这里有个BUG，具体参考&lt;a href=&quot;http://valleylord.github.io/post/201603-kubernetes-roll/&quot;&gt;这里&lt;/a&gt;&lt;/strong&gt;)&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;metadata.namespace&lt;/code&gt; 命名空间必须的是一样的&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;下面我们将上面的&lt;code class=&quot;highlighter-rouge&quot;&gt;myweb&lt;/code&gt;进行一下升级，内容如下&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ReplicationController&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb-v2&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;replicas&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;5&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v2&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;deployment&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v2&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v2&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;deployment&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v2&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# 该处声明一个volume&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;datavol&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;emptyDir&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;{}&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;kubeguide/tomcat-app:v2&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;containerPort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;8080&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MYSQL_SERVICE_HOST&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;mysql-service'&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MYSQL_SERVICE_PORT&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;13306'&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# 该处进行引用并挂在到容器内部&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;volumeMounts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;datavol&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/mydata-data&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;啊哦，升级的时候报错了&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;error: myweb-rc-update.yml must specify a matching key with non-equal value &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;Selector &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;myweb
See &lt;span class=&quot;s1&quot;&gt;'kubectl rolling-update -h'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;help &lt;/span&gt;and examples.
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;没关系，既然用yaml文件无法升级，我们用命令的形式来试试&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubectl rolling-update myweb --image&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;kubeguide/tomcat-app:v2
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;OK，成了，开始升级了&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 我们发现旧的rc正在逐步减少，新的rc正在增多&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl get rc
NAME                                     DESIRED   CURRENT   READY     AGE
mysql                                    1         1         1         34m
myweb                                    2         2         2         19m
myweb-c1dc64330c885b62eca9fb5aafbfecc6   4         4         4         3m

&lt;span class=&quot;c&quot;&gt;# 旧的pods也正在一个个的被新的pod替换&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl get pods
NAME                                           READY     STATUS    RESTARTS   AGE
mysql-65lw6                                    1/1       Running   0          35m
myweb-c1dc64330c885b62eca9fb5aafbfecc6-88f8v   1/1       Running   0          4m
myweb-c1dc64330c885b62eca9fb5aafbfecc6-c97fh   1/1       Running   0          58s
myweb-c1dc64330c885b62eca9fb5aafbfecc6-ttlpm   1/1       Running   0          2m
myweb-c1dc64330c885b62eca9fb5aafbfecc6-wd6kj   1/1       Running   0          3m
myweb-c1dc64330c885b62eca9fb5aafbfecc6-zr57k   1/1       Running   0          1m
myweb-k9tsj                                    1/1       Running   0          20m

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;成功了～&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 成功后，将RC名称改为myweb，升级完成&lt;/span&gt;
Created myweb-c1dc64330c885b62eca9fb5aafbfecc6
Scaling up myweb-c1dc64330c885b62eca9fb5aafbfecc6 from 0 to 5, scaling down myweb from 5 to 0
Scaling myweb-c1dc64330c885b62eca9fb5aafbfecc6 up to 1
Scaling myweb down to 4
Scaling myweb-c1dc64330c885b62eca9fb5aafbfecc6 up to 2
Scaling myweb down to 3
Scaling myweb-c1dc64330c885b62eca9fb5aafbfecc6 up to 3
Scaling myweb down to 2
Scaling myweb-c1dc64330c885b62eca9fb5aafbfecc6 up to 4
Scaling myweb down to 1
Scaling myweb-c1dc64330c885b62eca9fb5aafbfecc6 up to 5
Scaling myweb down to 0
Update succeeded. Deleting old controller: myweb
Renaming myweb-c1dc64330c885b62eca9fb5aafbfecc6 to myweb
replicationcontroller &lt;span class=&quot;s2&quot;&gt;&quot;myweb&quot;&lt;/span&gt; rolling updated
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;那么为什么，我们在上面用yaml文件无法升级呢？&lt;/p&gt;

&lt;p&gt;经过一段时间的折腾，我发现，我旧的RC文件只有一个label，app=myweb;而当我用命令升级成功后,新的RC有了两个label，app=myweb和deployment=xxxxx&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 未升级之前的RC&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl get rc -o wide
NAME      DESIRED   CURRENT   READY     AGE       CONTAINER&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;S&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;   IMAGE&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;S&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;                  SELECTOR
mysql     1         1         1         48m       mysql          mysql                     &lt;span class=&quot;nv&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;mysql
myweb     5         5         5         8s        myweb          kubeguide/tomcat-app:v1   &lt;span class=&quot;nv&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;myweb

&lt;span class=&quot;c&quot;&gt;# 升级后的RC&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl get rc -o wide
NAME       DESIRED   CURRENT   READY     AGE       CONTAINER&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;S&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;   IMAGE&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;S&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;                  SELECTOR
mysql      1         1         1         43m       mysql          mysql                     &lt;span class=&quot;nv&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;mysql
myweb      4         4         4         6m        myweb          kubeguide/tomcat-app:v2   &lt;span class=&quot;nv&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;myweb,deployment&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;c1dc64330c885b62eca9fb5aafbfecc6
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;然后当我再次对这个新的RC进行升级的时候，我发现是可以用yaml文件升级的，这说明什么？是不是旧的RC文件至少需要两个label才能用yaml文件升级呢？我们试试再说&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;为myweb添加不少于一个的label
    &lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# api版本，类型，全局唯一名称，这是所有kubernetes yaml文件都需要的&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ReplicationController&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# 定义pod期望数量&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;replicas&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# 用于筛选目标的selector 如果不指定，默认和.spec.template.labels的值相同&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# 当Pod副本数和期望数不一致时，用于创建新pod的模板&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# 该处声明一个volume&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;datavol&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;emptyDir&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;{}&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;kubeguide/tomcat-app:v1&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;containerPort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;8080&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MYSQL_SERVICE_HOST&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;mysql-service'&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MYSQL_SERVICE_PORT&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;3306'&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# 该处进行引用并挂在到容器内部&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;volumeMounts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;datavol&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/mydata-data&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;新建一个用来升级myweb的yaml文件&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ReplicationController&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb-v2&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;replicas&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;5&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v2&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;deployment&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v2&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v2&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;deployment&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v2&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# 该处声明一个volume&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;datavol&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;emptyDir&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;{}&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;kubeguide/tomcat-app:v2&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;containerPort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;8080&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MYSQL_SERVICE_HOST&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;mysql-service'&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MYSQL_SERVICE_PORT&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;13306'&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# 该处进行引用并挂在到容器内部&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;volumeMounts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;datavol&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/mydata-data&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;我发现，真的可以升级了!!!&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl rolling-update myweb -f myweb-rc-update.yml
Created myweb-v2
Scaling up myweb-v2 from 0 to 5, scaling down myweb from 5 to 0
Scaling myweb-v2 up to 1
Scaling myweb down to 4
Scaling myweb-v2 up to 2
Scaling myweb down to 3
Scaling myweb-v2 up to 3
Scaling myweb down to 2
Scaling myweb-v2 up to 4
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;这说明什么？这说明，以后如果你要用&lt;code class=&quot;highlighter-rouge&quot;&gt;ReplicationController&lt;/code&gt;的时候，至少要给他指定不少于2个的label，否则，你无法用yaml来进行升级，这真的是很蛋疼的一件事。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;当然了，保不齐以后kubernetes会将&lt;code class=&quot;highlighter-rouge&quot;&gt;ReplicationController&lt;/code&gt;抛弃掉，毕竟现在它已经有了更好的&lt;code class=&quot;highlighter-rouge&quot;&gt;Deployment&lt;/code&gt;和&lt;code class=&quot;highlighter-rouge&quot;&gt;StatefulSet&lt;/code&gt;等…&lt;/p&gt;

&lt;h3 id=&quot;horizontal-pod-autoscaler-hpa&quot;&gt;Horizontal Pod Autoscaler (HPA)&lt;/h3&gt;

&lt;p&gt;前面我们说到能用&lt;code class=&quot;highlighter-rouge&quot;&gt;kubectl scale&lt;/code&gt;命令来手动实现 Pod 的扩容和缩容，这未免也太 low 了吧，我们既然用了kubernetes，那就是因为他的智能化，自动化。所以这里我们要讲讲kubernetes的智能扩容 HPA。&lt;/p&gt;

&lt;p&gt;HPA 基于获取到的metrics value(CPU utilization,custom metrics),对RC,Deployment管理的pods进行自动伸缩。HPA是kubernetes &lt;code class=&quot;highlighter-rouge&quot;&gt;autoscaling&lt;/code&gt; API组中的一个API资源，当前的stable版本只支持CPU，alpha版本中红，已经开始支持memory和custom metrics。&lt;/p&gt;

&lt;p&gt;HPA 以kubernetes API resource 和一个controller来实现，resource决定了controller的行为，而controller控制着pods的数量。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;截至到kubernetes 1.6 ，Release特性中仅支持CPU utilization这一 &lt;code class=&quot;highlighter-rouge&quot;&gt;resource metrics&lt;/code&gt;, 对&lt;code class=&quot;highlighter-rouge&quot;&gt;custom metrics&lt;/code&gt;的支持目前仍在alpha阶段。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;HPA controller 周期性的调整对应rc，deployment中的pods数量，使得获取到的&lt;code class=&quot;highlighter-rouge&quot;&gt;metrics value&lt;/code&gt;能匹配用户指定的&lt;code class=&quot;highlighter-rouge&quot;&gt;target utilization&lt;/code&gt;。这个周期默认为30s，可以通过&lt;code class=&quot;highlighter-rouge&quot;&gt;kube-controller-manager&lt;/code&gt;的flag &lt;code class=&quot;highlighter-rouge&quot;&gt;--horizontal-pod-autoscaler-sync-period&lt;/code&gt;进行设置。&lt;/p&gt;

&lt;p&gt;在每个HPA Controller的处理周期中，kube-controller-manager都去查询HPA获取到的metrics的utilization。查询方式根据metric类型不同而不同：&lt;/p&gt;

&lt;p&gt;如果metric type是resource metrics，则通过resource metrics API查询，直接通过Heapster访问
如果metric type属于custom metrics，则通过custom metrics API查询，通过REST client来访问&lt;/p&gt;

&lt;p&gt;计算伸缩比例算法：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;对于 resource metrics,比如 CPU，HPA controller 从resource metrics API中获取CPU metrics，如果HPA中设定了target utilization，则HPA controller 会将获取到的CPU metrics 除以对应容器的resource request值作为检测到的当前pod的resource utilization。如此计算完所有HPA对应的pods后，对该resource utilization values取平均值。最后将平均值除与定义的target utilization，得到伸缩比例。&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意：如果HPA对应的某些pods中的容器没有定义resource request，则HPA不会对这些pods进行scale&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;对于custome metrics，HPA Controller的伸缩算法几乎与resource metrics一样，不同的是：此时是根据custome metrics API查询到的metrics value对比target metrics value计算得到的，而不是通过utilization计算得到的&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;对于object metrics，HPA Controller获取到一个metric 值，然后与target metrics比较，得到如上所说的比率&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;HPA可以通过命令来实现，也可以通过配置文件的方式来实现。&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl autoscale deployment php-apache --cpu-percent&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;50 --min&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 --max&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10
deployment &lt;span class=&quot;s2&quot;&gt;&quot;php-apache&quot;&lt;/span&gt; autoscaled
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;下面我们用实验来感受下HPA&lt;/p&gt;

&lt;p&gt;首先我们来新建一个&lt;code class=&quot;highlighter-rouge&quot;&gt;php-apache&lt;/code&gt;的服务&lt;/p&gt;

&lt;p&gt;php-apache-deploy.yml&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;extensions/v1beta1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Deployment&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;php-apache&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;namespace&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;default&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;replicas&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;matchLabels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;k8s-quark&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;php-apache&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;k8s-quark&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;php-apache&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;php-apache&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;gcr.io/google_containers/hpa-example:latest&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;imagePullPolicy&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;IfNotPresent&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;containerPort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;80&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;resources&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;requests&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;cpu&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;200m&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;php-apache-svc.yml&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Service&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;php-apache&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;80&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;k8s-quark&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;php-apache&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubectl create -f php-apache-deploy.yml
kubectl create -f php-apache-svc.yml

&lt;span class=&quot;c&quot;&gt;# 查看当前的deployment&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl get deployment php-apache
NAME         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
php-apache   1         1         1            1           10m

&lt;span class=&quot;c&quot;&gt;# 查看php-apache的pods&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl get pods |grep php-apache
php-apache-3548797493-twq7k       1/1       Running   0          17m
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;然后，我们用命令来创建一个HPA&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubectl autoscale deployment php-apache --cpu-percent&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;50 --min&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 --max&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10

&lt;span class=&quot;c&quot;&gt;# 看看我们创建好的hpa&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$  &lt;/span&gt;kubectl get hpa
NAME         REFERENCE               TARGETS    MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache   0% / 50%   1         10        1          19m

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;这条命令的意思是，我们为&lt;code class=&quot;highlighter-rouge&quot;&gt;php-apache&lt;/code&gt;创建了一个HPA，指定了target metrics value是cpu利用率50%，而伸缩最小值为1，最大值为10&lt;/p&gt;

&lt;p&gt;最后，我们来持续访问&lt;code class=&quot;highlighter-rouge&quot;&gt;php-apache&lt;/code&gt;来给它压力，看看HPA会不会自动为我们扩容呢？&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 进入一个容器&lt;/span&gt;
kubectl run -ti load-generator --image&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;busybox /bin/sh

&lt;span class=&quot;c&quot;&gt;# 持续访问&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;while &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;; &lt;span class=&quot;k&quot;&gt;do &lt;/span&gt;wget -q -O- http://php-apache.default.svc.cluster.local; &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;过了几分钟，我们看看结果咋样&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# HPA状态&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$  &lt;/span&gt;kubectl get hpa
NAME         REFERENCE               TARGETS      MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache   313% / 50%   1         10        4          22m

&lt;span class=&quot;c&quot;&gt;# deployment状态&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$  &lt;/span&gt;kubectl get deployment php-apache
NAME         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
php-apache   4         4         4            4           25m

&lt;span class=&quot;c&quot;&gt;# HPA状态&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$  &lt;/span&gt;kubectl get hpa
NAME         REFERENCE               TARGETS     MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache   90% / 50%   1         10        8          26m

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;我们发现，随着我们的持续访问增压，HPA会自动的为我们将&lt;code class=&quot;highlighter-rouge&quot;&gt;php-apache&lt;/code&gt;进行扩容，随着&lt;code class=&quot;highlighter-rouge&quot;&gt;php-apahce&lt;/code&gt;的扩容，CPU开始慢慢下降，直到最终符合我们指定的低于50%的标准，或者达到最大值10个POD。而当我们停止对&lt;code class=&quot;highlighter-rouge&quot;&gt;php-apache&lt;/code&gt;的访问，最终，HPA会恢复到默认1个pod的状态。&lt;/p&gt;

&lt;p&gt;用yaml文件的方式，最终的效果和上面是一样的&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;autoscaling/v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;HorizontalPodAutoscaler&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;php-apache&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;namespace&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;default&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# 指定针对谁来使用HPA&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;scaleTargetRef&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;extensions/v1beta1&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Deployment&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;php-apache&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;minReplicas&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;maxReplicas&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;10&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# 用户定义的CPU利用率&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;targetCPUUtilizationPercentage&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;50&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;至于其它的HPA metrica，改天再讲吧，毕竟现在还只是alpha版本，而且需要heapster目前也无法收集那么多metrics&lt;/p&gt;

&lt;h3 id=&quot;service&quot;&gt;Service&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/service-rc-pod.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;透过上图，我们可以发现，service定义了一个服务的访问入口地址，前端的pod通过这个入口地址来访问其背后一组由pod组成的集群实例，而背后这组pod则是通过RC来生成并保持住的。他们三者之间，通过&lt;code class=&quot;highlighter-rouge&quot;&gt;label selector&lt;/code&gt;来保持关联。&lt;/p&gt;

&lt;p&gt;我们知道，正常情况下，要通过一个如果访问后端的集群服务，最好的办法是在前端弄一个负载均衡(nginx,haproxy…)，暴露一个对外服务的端口，然后反代到后端的ip+port。而kubernetes也遵循了这样的做法。
在上图中，frontal pod 访问 service 时，kubernetes其实是通过其内部的 kube-proxy 来进行负载均衡，然后将请求转发到后端的某个pod上。但kubernetes不是使用的一个实际的负载均衡IP地址，而是为每个service分配了一个全局唯一的虚拟IP地址，这个虚拟IP被称为Cluster IP，只能在kubernetes 集群内部被访问(意思就是只能在集群内的pod中才能访问)，而且一旦创建，在service的整个生命周期内，都不会发生变动。&lt;/p&gt;

&lt;p&gt;下面我们来创建一个service看看&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Service&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# service全局唯一名称，后面在cluster中可以直接使用的名称&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;tomcat-service&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# service提供服务的端口&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;8080&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;service-port&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# 后端容器提供服务暴露的端口，如果不指定，默认暴露service提供服务的端口&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;targetPort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;8080&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;8005&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;shutown-port&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;targetPort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;8005&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# 指定label selector 确认该服务和后端那些pod关联起来&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mysql&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;kubernetes服务发现机制&quot;&gt;kubernetes服务发现机制&lt;/h4&gt;

&lt;p&gt;最开始的时候kubernetes使用变量的形式，来发现服务，后来使用内部DNS来进行服务名解析，还有人认为使用consul的服务发现机制，其实我并不觉得这比内部的DNS服务发现好多少。&lt;/p&gt;

&lt;h5 id=&quot;kubernetes内部dns寻址服务发现&quot;&gt;kubernetes内部dns寻址服务发现&lt;/h5&gt;

&lt;p&gt;1.kubectl 执行创建的时候会向APIServer请求创建一个service。APIServer获取到请求后调用相应的api创建一个service对象，并写入etcd保存。
2.kube-dns通过&lt;code class=&quot;highlighter-rouge&quot;&gt;list/watch&lt;/code&gt;操作向APIServer发送GET请求。这时因为有service的创建，所以APIServer会相应这个请求并把service回复给kube-dns。
3.APIServer将创建的service信息回复给kube-dns,还会附带一个APIServer分配给service的Cluster IP。
4.kube-dns通过检测并得到APIServer回复的service信息，会生成DNS条目，并把这个DNS条目存储到内存(Tree-Cache)中
5.kubernetes中访问service的时候，会先去dnsmasq中查找缓存，找不到则去kubedns中查找dns条目，最终实现service的解析。(sidecar是用于检查其他两个容器的健康状态)&lt;/p&gt;

&lt;p&gt;通过dns的服务发现机制，有个弊端就是服务的健康检查，不过这一点通过pod的健康检查可以填补。&lt;/p&gt;

&lt;h5 id=&quot;consuletcd等服务发现机制&quot;&gt;consul、etcd等服务发现机制&lt;/h5&gt;

&lt;p&gt;consul：这个具体还没实施过，大致意思就是，容器启动时注册自己的ip+port到consul，然后consul自己做健康检查，最终将其发往fabio，fabio是个大路由，前端统一反代到fabio。
etcd：大体实现方式，就是写脚本通过etcd的api注册服务，然后再写一个service discover的脚本循环查询注册进去的service，对比template中的内容，然后生成新的配置文件进行更新。&lt;/p&gt;

&lt;h4 id=&quot;kubernetes-service-暴露&quot;&gt;kubernetes service 暴露&lt;/h4&gt;

&lt;p&gt;目前kubernetes service 暴露的方式有如下几种&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;ClusterIP 只提供kubernetes集群内部的服务发现&lt;/li&gt;
  &lt;li&gt;NodePort 在每个节点上提供端口暴露服务&lt;/li&gt;
  &lt;li&gt;LoadBlancer 只能在云平台上使用，使用云平台提供的LB来暴露服务&lt;/li&gt;
  &lt;li&gt;ExternalName 与另一个域名绑定，通过该service访问另一个服务&lt;/li&gt;
  &lt;li&gt;ingress/traefik 使用第三方插件将pod暴露出来&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;而无论是ClusterIP 还是 NodePort 都是通过kube-proxy来对service进行实现的，而kube-proxy又有两种方式来实现负载，userspace和iptables，下面我来说一下kubernetes默认的iptables方式的kube-proxy&lt;/p&gt;

&lt;p&gt;首先，我们来新建一个NodePort类型的服务&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Service&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb-service&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;NodePort&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;8080&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;nodePort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;30001&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myweb&lt;/span&gt;         
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;myweb-service 代理了后端的一个pod，ip为10.233.88.53，看看iptables&lt;/p&gt;

&lt;p&gt;下面来逐条分析&lt;/p&gt;

&lt;p&gt;如果是通过node的30001来访问，则会进入如下的链&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 看看和NodePort  30001有关的iptables&lt;/span&gt;

&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;iptables -S -t nat |grep 30001
-A KUBE-NODEPORTS -p tcp -m comment --comment &lt;span class=&quot;s2&quot;&gt;&quot;default/myweb-service:&quot;&lt;/span&gt; -m tcp --dport 30001 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment &lt;span class=&quot;s2&quot;&gt;&quot;default/myweb-service:&quot;&lt;/span&gt; -m tcp --dport 30001 -j KUBE-SVC-KINM4OXG42E5QTAT
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;然后进一步跳转到&lt;code class=&quot;highlighter-rouge&quot;&gt;KUBE-SVC-KINM4OXG42E5QTAT&lt;/code&gt;的链&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;-A KUBE-SVC-KINM4OXG42E5QTAT -m comment --comment &lt;span class=&quot;s2&quot;&gt;&quot;default/myweb-service:&quot;&lt;/span&gt; -j KUBE-SEP-I4OJ7A6SXM5YG2QP
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;然后会跳转到&lt;code class=&quot;highlighter-rouge&quot;&gt;KUBE-SEP-I4OJ7A6SXM5YG2QP&lt;/code&gt;链，最终将请求转发到10.233.88.53的pod上&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;-A KUBE-SEP-I4OJ7A6SXM5YG2QP -p tcp -m comment --comment &lt;span class=&quot;s2&quot;&gt;&quot;default/myweb-service:&quot;&lt;/span&gt; -m tcp -j DNAT --to-destination 10.233.88.53:8080
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;注意：如果service代理了多个pod的话，会利用iptables的–probability特性，按一定的比例转发，如下&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;假若我们的myweb-service代理了3个pod&lt;/p&gt;

&lt;p&gt;如果是通过node的30001来访问，则会进入如下的链&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 看看和NodePort  30001有关的iptables&lt;/span&gt;

&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;iptables -S -t nat |grep 30001
-A KUBE-NODEPORTS -p tcp -m comment --comment &lt;span class=&quot;s2&quot;&gt;&quot;default/myweb-service:&quot;&lt;/span&gt; -m tcp --dport 30001 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment &lt;span class=&quot;s2&quot;&gt;&quot;default/myweb-service:&quot;&lt;/span&gt; -m tcp --dport 30001 -j KUBE-SVC-KINM4OXG42E5QTAT
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;然后进一步跳转到&lt;code class=&quot;highlighter-rouge&quot;&gt;KUBE-SEP-5I5KUCBAI2CKFMN2&lt;/code&gt;、&lt;code class=&quot;highlighter-rouge&quot;&gt;KUBE-SEP-I4OJ7A6SXM5YG2QP&lt;/code&gt;、&lt;code class=&quot;highlighter-rouge&quot;&gt;KUBE-SEP-FDQHGZ7N6PHRDJRL&lt;/code&gt;的链&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 有分为30%，50%，20%的几率&lt;/span&gt;
-A KUBE-SVC-KINM4OXG42E5QTAT -m comment --comment &lt;span class=&quot;s2&quot;&gt;&quot;default/myweb-service:&quot;&lt;/span&gt; -m statistic --mode random --probability 0.33332999982 -j KUBE-SEP-5I5KUCBAI2CKFMN2

-A KUBE-SVC-KINM4OXG42E5QTAT -m comment --comment &lt;span class=&quot;s2&quot;&gt;&quot;default/myweb-service:&quot;&lt;/span&gt; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-I4OJ7A6SXM5YG2QP

-A KUBE-SVC-KINM4OXG42E5QTAT -m comment --comment &lt;span class=&quot;s2&quot;&gt;&quot;default/myweb-service:&quot;&lt;/span&gt; -j KUBE-SEP-FDQHGZ7N6PHRDJRL
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;然后会分别跳到上面每个链下对应的链，最终转发到对应的pod上&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# KUBE-SEP-5I5KUCBAI2CKFMN2&lt;/span&gt;
-A KUBE-SEP-5I5KUCBAI2CKFMN2 -p tcp -m comment --comment &lt;span class=&quot;s2&quot;&gt;&quot;default/myweb-service:&quot;&lt;/span&gt; -m tcp -j DNAT --to-destination 10.233.87.108:8080

&lt;span class=&quot;c&quot;&gt;# KUBE-SEP-I4OJ7A6SXM5YG2QP&lt;/span&gt;
-A KUBE-SEP-I4OJ7A6SXM5YG2QP -p tcp -m comment --comment &lt;span class=&quot;s2&quot;&gt;&quot;default/myweb-service:&quot;&lt;/span&gt; -m tcp -j DNAT --to-destination 10.233.88.53:8080

&lt;span class=&quot;c&quot;&gt;# KUBE-SEP-FDQHGZ7N6PHRDJRL&lt;/span&gt;
-A KUBE-SEP-FDQHGZ7N6PHRDJRL -p tcp -m comment --comment &lt;span class=&quot;s2&quot;&gt;&quot;default/myweb-service:&quot;&lt;/span&gt; -m tcp -j DNAT --to-destination 10.233.96.254:8080
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;好了，说完了NodePort，然后我们再说ClusterIP&lt;/p&gt;

&lt;p&gt;继续从上面看到尾就行了。&lt;/p&gt;

&lt;p&gt;ingress和traefik留到后面单独留个篇幅来说吧，这里就不说了。&lt;/p&gt;

&lt;h3 id=&quot;volume&quot;&gt;Volume&lt;/h3&gt;

&lt;p&gt;kubernetes 的volume要说的内容就很多了。&lt;/p&gt;

&lt;p&gt;首先volume是一个在pod中能被多个容器访问的共享目录，它是定义在pod上，然后挂载到容器下，而且它的生命周期只和pod有关。常见的存储类型有如下几种&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;emptyDir&lt;/li&gt;
  &lt;li&gt;hostPath&lt;/li&gt;
  &lt;li&gt;GCE Persistent Disks&lt;/li&gt;
  &lt;li&gt;NFS&lt;/li&gt;
  &lt;li&gt;RBD&lt;/li&gt;
  &lt;li&gt;ISCSCI&lt;/li&gt;
  &lt;li&gt;AWS ElasticBlockStore&lt;/li&gt;
  &lt;li&gt;GlusterFS&lt;/li&gt;
  &lt;li&gt;secret&lt;/li&gt;
  &lt;li&gt;PersistentVolume&lt;/li&gt;
  &lt;li&gt;downwardAPI&lt;/li&gt;
  &lt;li&gt;projected&lt;/li&gt;
  &lt;li&gt;configmap&lt;/li&gt;
  &lt;li&gt;local&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;注意：gitRepo实际上也是挂载一个空目录，从GIT仓库中clone内容下来供pod使用，所以它的数据也无法永久保存&lt;/strong&gt;&lt;/p&gt;

&lt;h4 id=&quot;emptydir&quot;&gt;emptyDir&lt;/h4&gt;

&lt;p&gt;正如它的名字一样，这是一个空的目录，它是在Pod被分配到node节点上的时候被创建的，无需在宿主机node上指定对应的目录文件。而且当pod从节点上被删除之后，emptyDir中的数据也会被删除，emptyDir 一般用在如下几个地方&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;暂存空间，例如用于基于磁盘的归并排序或长计算的检查点的暂存空间&lt;/li&gt;
  &lt;li&gt;临时目录，临时储存那些无需持久化的数据&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;默认情况下，&lt;code class=&quot;highlighter-rouge&quot;&gt;emptyDir&lt;/code&gt; 数据存储在SSD或者网络存储上。但是，你也可以设置&lt;code class=&quot;highlighter-rouge&quot;&gt;emptyDir.medium&lt;/code&gt;为&lt;code class=&quot;highlighter-rouge&quot;&gt;Memory&lt;/code&gt;来启用&lt;code class=&quot;highlighter-rouge&quot;&gt;tmpfs&lt;/code&gt;,tmpfs会将数据写入到内存中，因此，当机器重启之后，数据也会永久删除，并且，因为是存放在内存中，这些数据会占用你容器内存的limit指标。&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Pod&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-pd&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nginx&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-container&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;volumeMounts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/cache&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cache-volume&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cache-volume&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;emptyDir&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;medium&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Memory&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;secret&quot;&gt;secret&lt;/h4&gt;

&lt;p&gt;secret volume 使用来传递敏感信息，比如说密码之类的。我们可以将在kubernetes中定义的secret直接挂载为文件让pod访问。secret volume实际是通过tmpfs(内存文件系统)来实现的，所以这些信息不会持久保存。&lt;/p&gt;

&lt;h4 id=&quot;downwardapi&quot;&gt;downwardAPI&lt;/h4&gt;

&lt;p&gt;如果你想将pod或container里面的字段暴露给其他正在运行的容器，那么downwardAPI正是你所需要的，它会将pod或container里面的字段以文件的形式存储下来，然后挂载到对应的容器中。&lt;/p&gt;

&lt;p&gt;目前能暴露的字段&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;node’s name&lt;/li&gt;
  &lt;li&gt;pod’s name&lt;/li&gt;
  &lt;li&gt;pod’s namespace&lt;/li&gt;
  &lt;li&gt;pod’s ip&lt;/li&gt;
  &lt;li&gt;pod’s serviceAccount name&lt;/li&gt;
  &lt;li&gt;pod’s UID&lt;/li&gt;
  &lt;li&gt;pod’s labels&lt;/li&gt;
  &lt;li&gt;pod’s annotations&lt;/li&gt;
  &lt;li&gt;容器 CPU limit&lt;/li&gt;
  &lt;li&gt;容器 CPU request&lt;/li&gt;
  &lt;li&gt;容器 memory limit&lt;/li&gt;
  &lt;li&gt;容器 memory request&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Pod&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;kubernetes-downwardapi-volume-example&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;zone&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;us-est-coast&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;cluster&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-cluster1&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;rack&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;rack-22&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;annotations&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;two&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;builder&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;john-doe&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;client-container&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;gcr.io/google_containers/busybox&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;sh&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;-c&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;while true; do&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;if [[ -e /etc/labels ]]; then&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;echo -en '\n\n'; cat /etc/labels; fi;&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;if [[ -e /etc/annotations ]]; then&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;echo -en '\n\n'; cat /etc/annotations; fi;&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;sleep 5;&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;done;&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;volumeMounts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;podinfo&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/etc&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;readOnly&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;podinfo&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;downwardAPI&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;items&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;labels&quot;&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;fieldRef&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;s&quot;&gt;fieldPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;metadata.labels&lt;/span&gt;
          &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;annotations&quot;&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;fieldRef&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;s&quot;&gt;fieldPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;metadata.annotations&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;projected&quot;&gt;projected&lt;/h4&gt;

&lt;p&gt;projected volume 可以将几个volume内容隐射到同样的目录中，当前只支持secret、configmap、downwardAPI&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Pod&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;volume-test&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;container-test&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;busybox&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;volumeMounts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;all-in-one&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/projected-volume&quot;&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;readOnly&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;true&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;all-in-one&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;projected&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;sources&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;secret&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mysecret&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;items&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;username&lt;/span&gt;
              &lt;span class=&quot;s&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;my-group/my-username&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;downwardAPI&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;items&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;labels&quot;&lt;/span&gt;
              &lt;span class=&quot;s&quot;&gt;fieldRef&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
                &lt;span class=&quot;s&quot;&gt;fieldPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;metadata.labels&lt;/span&gt;
            &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;cpu_limit&quot;&lt;/span&gt;
              &lt;span class=&quot;s&quot;&gt;resourceFieldRef&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
                &lt;span class=&quot;s&quot;&gt;containerName&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;container-test&lt;/span&gt;
                &lt;span class=&quot;s&quot;&gt;resource&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;limits.cpu&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;configMap&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;myconfigmap&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;items&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;config&lt;/span&gt;
              &lt;span class=&quot;s&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;my-group/my-config&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;local&quot;&gt;local&lt;/h4&gt;

&lt;p&gt;local volume在1.7中目前还是alpha版本，主要是用来将本地的disk，分区或者目录进行挂载。local volume只能以静态创建的PV使用。相对于HostPath，localhost可以直接以持久化的方式使用（它总是通过NodeAffinity调度在某个指定的节点上），而hostpath是无法直接以pv来使用的。&lt;/p&gt;

&lt;h4 id=&quot;hostpath&quot;&gt;hostPath&lt;/h4&gt;

&lt;p&gt;hostPath 就是将宿主机上的目录或文件挂在到pod里。比如我们常用到&lt;code class=&quot;highlighter-rouge&quot;&gt;hostPath&lt;/code&gt;的几个例子&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;容器应用程序的日志，需要永久保存时，可以使用hostPath隐射宿主机上的高速文件存储&lt;/li&gt;
  &lt;li&gt;运行的容器需要访问Docker内部结构：使用hostPath映射/var/lib/docker&lt;/li&gt;
  &lt;li&gt;在容器中运行cAdvisor，使用hostPath映射/dev/cgroups&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;而当我们在使用hostPath的时候需要注意以下几点&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;在不同Node上具有相同配置的pod(通过podTemplate创建的)，可能会因为宿主机上的目录和文件不同而导致volume上目录和文件的访问结果不一致&lt;/li&gt;
  &lt;li&gt;如果使用资源配额，无法将hostPath在宿主机上使用的资源纳入管理&lt;/li&gt;
  &lt;li&gt;如果宿主机上的目录是root权限，那么你也必须以root身份来运行你的进程，或者，修改你的目录权限以便于能让hostPath卷有写权限&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Pod&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-pd&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nginx&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-container&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;volumeMounts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/test-pd&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-volume&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-volume&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;hostPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/data&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;其实hostPath也能算是持久存储的一种，只不过局限性太大了。这里我们详细的讲讲外部存储和分布式存储在kubernetes中的使用(aws和gce的就不讲了，没环境)。&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes/tree/master/examples/volumes&quot;&gt;详细的例子&lt;/a&gt;大家可以参考官方的例子&lt;/p&gt;

&lt;h4 id=&quot;nfs&quot;&gt;NFS&lt;/h4&gt;

&lt;p&gt;NFS是Network File System的缩写，即网络文件系统。kubernetes中通过简单的配置就可以挂载NFS到Pod中，而NFS中的数据是可以永久保存的，同时NFS支持同时写操作。&lt;/p&gt;

&lt;p&gt;首先，你得有个已经搭建好的NFS服务&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Pod&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-pd&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nginx&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-container&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;volumeMounts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/test-pd&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-volume&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-volume&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;nfs&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;163.xx.xx.xx&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;persistent-volume&quot;&gt;persistent volume&lt;/h4&gt;

&lt;p&gt;事实上，我们可以单独在Pod中指定外部存储，也可以将这些外部存使用PersistentVolume资源化。&lt;/p&gt;

&lt;p&gt;之前我们提到的volume都是定义在pod上的，和 pod 是一种静态绑定关系，属于”计算资源”的一部分，而实际上，“网络存储”是独立于“计算资源”之外而存在的一种实体资源。比如我们在使用虚机的情况下，我们通常会定义一个网络存储，然后从中划出一定的空间连接到虚拟机。而persistent volume和与之关联的persistent volume claim就起到了类似的作用。&lt;/p&gt;

&lt;p&gt;PersistentVolume(PV)是集群中的一块网络存储，用来提供网络存储资源 。跟Node一样，也是集群的资源。PV 跟volume类似，不过会有独立于Pod的生命周期。
PersistentVolumeClaim(PVC)是对PV的请求。PVC有点类似于Pod，pod消耗node的资源，而PVC消耗PV的资源。Pod请求CPU和内存，而PVC请求特定大小和访问模式的数据卷。&lt;/p&gt;

&lt;p&gt;PV的访问模式有三种：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;ReadWriteOnce(RWO):最基本的访问方式，可读可写，但只支持被耽搁pod挂载&lt;/li&gt;
  &lt;li&gt;ReadOnlyMany(ROX):可以以只读的方式被多个pod挂载&lt;/li&gt;
  &lt;li&gt;ReadWriteMany(RWX):以读写的方式被多个POD挂载。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;并不是所有存储都支持这三种方式，像共享方式，目前支持的还比较少，比较常用的是NFS。在PVC绑定PV时通常根据两个条件来绑定，一个实存储大小，一个是访问方式。
&lt;strong&gt;需要注意的是，虽然PV支持三种访问模式，但它同时只支持一种方式来访问PV&lt;/strong&gt;&lt;/p&gt;

&lt;h5 id=&quot;创建pv的方式有两种&quot;&gt;创建PV的方式有两种&lt;/h5&gt;

&lt;p&gt;有两种创建PV的方式：静态和动态&lt;/p&gt;

&lt;h6 id=&quot;静态&quot;&gt;静态&lt;/h6&gt;

&lt;p&gt;所谓静态，就是管理员手动创建一堆PV，组成一个PV池，供PVC来绑定。&lt;/p&gt;

&lt;h6 id=&quot;动态&quot;&gt;动态&lt;/h6&gt;
&lt;p&gt;经过API抽象，用户可以通过PVC使用存储资源，通常用户还会关心PV的很多属性，例如对不同的应用场景需要不同的性能，仅仅提供存储大小和访问模式不能满足要求。集群管理员一方面要提供不同PV的多种属性，一方面要隐藏底层的细节，还有一点是不再需要管理员手动去创建PV,这就引入了&lt;code class=&quot;highlighter-rouge&quot;&gt;StorageClass&lt;/code&gt;资源。管理员用存储级别StorageClass描述存储的分类，不同的分类可以对应不同的质量服务Qos等级、备份策略和其他自定义的策略。kubernetes本身不参与存储级别的划分，StorageClass概念在有的存储系统里被称为”profiles”&lt;/p&gt;

&lt;p&gt;所谓动态，就是当所有的静态PV都不匹配用户的PVC时，集群通过storageClass的对象由存储系统根据PVC的要求自动创建。这种基于&lt;code class=&quot;highlighter-rouge&quot;&gt;StorageClass&lt;/code&gt;的PV，管理员必须事先创建和配置这样的storage class。请求等级配置为&lt;code class=&quot;highlighter-rouge&quot;&gt;&quot; &quot;&lt;/code&gt;的PVC，有效地禁用了它自身的动态供给功能。&lt;/p&gt;

&lt;h6 id=&quot;class&quot;&gt;class&lt;/h6&gt;

&lt;p&gt;我们可以根据不同的需求创建不同类型的PV(这种PV是基于&lt;code class=&quot;highlighter-rouge&quot;&gt;StorageClass&lt;/code&gt;，是自动创建的)，然后我们可以通过为PVC指定&lt;code class=&quot;highlighter-rouge&quot;&gt;storageClassName&lt;/code&gt;来请求PV，如果集群中有这个class，那么当用户请求的时候，kubernetes会自动的创建PV，如果集群中有默认的storageclass，那么你只需要创建PVC即可，无需指定&lt;code class=&quot;highlighter-rouge&quot;&gt;storageClassName&lt;/code&gt;,剩下的都有默认的动态配置来搞定。&lt;/p&gt;

&lt;p&gt;举个例子：比如我现在需要两种类型的存储，一种是SSD，一种是普通的硬盘，那么这时候，我就可以创建两种class的&lt;code class=&quot;highlighter-rouge&quot;&gt;StorageClass&lt;/code&gt;,然后在创建PVC时，指定不同的&lt;code class=&quot;highlighter-rouge&quot;&gt;storageClassName&lt;/code&gt;即可，如下：&lt;/p&gt;

&lt;p&gt;每个&lt;code class=&quot;highlighter-rouge&quot;&gt;StorageClass&lt;/code&gt;都包含&lt;code class=&quot;highlighter-rouge&quot;&gt;provisioner&lt;/code&gt;和&lt;code class=&quot;highlighter-rouge&quot;&gt;parameters&lt;/code&gt;这个两个字段，具体怎么配置这些storageclass，有哪些存储支持storageclass,请参考&lt;a href=&quot;https://kubernetes.io/docs/concepts/storage/persistent-volumes/&quot;&gt;官网&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;StorageClass&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;storage.k8s.io/v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;slow&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;provisioner&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;kubernetes.io/gce-pd&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;parameters&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;pd-standard&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;StorageClass&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;storage.k8s.io/v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;fast&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;provisioner&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;kubernetes.io/gce-pd&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;parameters&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;pd-ssd&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;PersistentVolumeClaim&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;pvc-fast&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;storageClassName&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;fast&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;accessModes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ReadOnlyMany&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;resources&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;requests&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;storage&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;2Gi&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;当用户请求资源的时候，如果是通过pvc-fast请求，这时候就会绑定到一个SSD，而不会绑定到普通硬盘。&lt;/p&gt;

&lt;h6 id=&quot;绑定&quot;&gt;绑定&lt;/h6&gt;

&lt;p&gt;在动态配置的情况下，当用户创建或者之前就已经创建了具有特定数量或具有某些访问模式的PVC的时候。master中的loop control会监视新的PVC，找到匹配的PV，然后将它们绑定到一起。如果这个PV是通过动态提供给PVC，那么loop control会始终绑定这个PV给这个PVC。否则，用户可能会一直请求PV，但是实际上又没有那么多PV资源。还需要注意的事，一旦绑定了PVC，就不能再绑定其他。&lt;/p&gt;

&lt;h6 id=&quot;使用&quot;&gt;使用&lt;/h6&gt;

&lt;p&gt;Pod使用PVC和使用Volume一样。集群检查PVC然后找到绑定的pv，然后隐射给pod使用。
一旦用户拥有了一个PVC，并且PVC被绑定，那么只要用户还需要，PV就一直属于这个用户。&lt;/p&gt;

&lt;h6 id=&quot;回收&quot;&gt;回收&lt;/h6&gt;

&lt;p&gt;当用户不在需要PV时，我们可以删除PVC来回收PV，&lt;code class=&quot;highlighter-rouge&quot;&gt;PersistentVolume&lt;/code&gt;中的回收策略会告诉kubernetes当PVC被释放后该怎么做，目前，支持的策略如下&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Retained(保留)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;当PVC被删除后，PV仍然被保留下来，并且会变成&lt;code class=&quot;highlighter-rouge&quot;&gt;released&lt;/code&gt;。但是它还不能被其他PVC使用，因为现在PV上仍然有上一个PVC所请求的数据。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Recycled(再利用)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;当PVC被删除后，kubernetes会将PV里的数据删除，然后把PV变成Available，然后又可以被新的PVC绑定&lt;/p&gt;

&lt;p&gt;这个原理实际上是：在删除PVC之后，会运行一个POD来执行一个(&lt;code class=&quot;highlighter-rouge&quot;&gt;rm -rf /thevolume/*&lt;/code&gt;)的操作，删除pv下的所有数据&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;默认回收运行的POD用的image是gcr上的busybox，而且image策略是always，因为这个原因，你可能始终无法回收PV，这时候，就需要去重新配置回收POD的模板了，模板内容如下&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Pod&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;recycler-for-nfs&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;namespace&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;default&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;restartPolicy&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Never&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;vol&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;nfs&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;163.xx.xx.xx&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;pv-recycler&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;gcr.io/google_containers/busybox&quot;&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;imagePullPolicy&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;IfNotPresent&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/bin/sh&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;-c&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;-e&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/scrub&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;rm&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;-rf&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/scrub/..?*&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/scrub/.[!.]*&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/scrub/*&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;  &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;-z&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;$(ls&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;-A&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/scrub)&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;volumeMounts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;vol&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/scrub&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;写好模板了，还需要在&lt;code class=&quot;highlighter-rouge&quot;&gt;kube-controller-manager&lt;/code&gt;中去配置模板，&lt;a href=&quot;https://kubernetes.io/docs/admin/kube-controller-manager/&quot;&gt;更多详细信息&lt;/a&gt;可参考官网&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# 指定nfs回收模板的位置&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;--pv-recycler-pod-template-filepath-nfs=/etc/kubernetes/recycler-for-nfs.yaml&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# 在容器下挂载模板文件&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;volumeMounts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/etc/kubernetes/recycler-for-nfs.yaml&quot;&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;recycler-nfs&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# 将宿主机上的模板文件挂载到pod&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;recycler-nfs&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;hostPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/etc/kubernetes/recycler-for-nfs.yaml&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;下面我们来新建PV和PVC来测试一下&lt;/p&gt;

&lt;p&gt;nfs-pv.yaml&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;PersistentVolume&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nfs&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;capacity&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;storage&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;5Gi&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;accessModes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ReadWriteOnce&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;persistentVolumeReclaimPolicy&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Recycle&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;nfs&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/&quot;&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;163.44.165.142&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;nfs-pvc.yaml&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;PersistentVolumeClaim&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nfs&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;accessModes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ReadWriteOnce&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;resources&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;requests&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;storage&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;5Gi&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;nfs-nginx.yaml&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Pod&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-pd&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nginx&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-container&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;volumeMounts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/test-pd&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-volume&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-volume&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;persistentVolumeClaim&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;claimName&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nfs&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;命令如下：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 创建PV,PVC以及关联的POD&lt;/span&gt;
kubectl create -f nfs-pv.yaml
kubectl create -f nfs-pvc.yaml
kubectl create -f nfs-nginx.yaml

&lt;span class=&quot;c&quot;&gt;# 查看创建的PV&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl get pv
NAME      CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS    CLAIM         STORAGECLASS   REASON    AGE
nfs       5Gi        RWO           Recycle         Bound     default/nfs                            1h

&lt;span class=&quot;c&quot;&gt;# 查看创建的PVC&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl get pvc
NAME      STATUS    VOLUME    CAPACITY   ACCESSMODES   STORAGECLASS   AGE
nfs       Bound     nfs       5Gi        RWO                          8m

&lt;span class=&quot;c&quot;&gt;# 然后我们进入pod中新建一个文件recycle-file&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; -ti &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-pd /bin/bash
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;touch recycle-file
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;我们发现nfs的回收策略是&lt;code class=&quot;highlighter-rouge&quot;&gt;Recycle&lt;/code&gt;，当前状态是&lt;code class=&quot;highlighter-rouge&quot;&gt;Bound&lt;/code&gt;，那么假如我现在将PVC删除掉呢，下面我们来操作试试看&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubectl delete -f nfs-nginx.yaml
kubectl delete -f nfs-pvc.yaml

&lt;span class=&quot;c&quot;&gt;# 查看现在的pv&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl get pv
NAME      CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS     CLAIM         STORAGECLASS   REASON    AGE
nfs       5Gi        RWO           Recycle         Released   default/nfs                            1h

&lt;span class=&quot;c&quot;&gt;# 过了一会儿，再看pv&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl get pv
NAME      CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS      CLAIM     STORAGECLASS   REASON    AGE
nfs       5Gi        RWO           Recycle         Available                                      1h

&lt;span class=&quot;c&quot;&gt;# 再重新使用PVC关联POD&lt;/span&gt;
kubectl create -f nfs-pvc.yaml
kubectl create -f nfs-nginx.yaml

&lt;span class=&quot;c&quot;&gt;# 进入pod中看看数据是否还存在&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;kubectl &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; -ti &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;-pd ls /test-pd
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;我们发现当我们的回收策略是&lt;code class=&quot;highlighter-rouge&quot;&gt;Recycle&lt;/code&gt;时，删除PVC之后，PV的状态先是&lt;code class=&quot;highlighter-rouge&quot;&gt;Released&lt;/code&gt;，然后过一会儿之后，会变成&lt;code class=&quot;highlighter-rouge&quot;&gt;Available&lt;/code&gt;状态，而且PV上的数据也已经被删除了，这时候就可以再次被其他的PVC使用了。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意：当前只有NFS和HostPath支持回收利用操作&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Delete(删除)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;当PVC被删除后，kubernetes会删除PV及里面的数据。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意：当前只有AWS EBS,GCE PD,AZURE DISK,OPENSTACK CINDER卷支持删除操作&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意：动态PV，总会在PVC被删除后被删除&lt;/strong&gt;&lt;/p&gt;

&lt;h6 id=&quot;pv阶段状态&quot;&gt;PV阶段状态&lt;/h6&gt;

&lt;p&gt;一个volume会处于下面的几个状态之一&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Avaliable 尚未绑定到PVC上的可用资源&lt;/li&gt;
  &lt;li&gt;Bound 已经被绑定到PVC&lt;/li&gt;
  &lt;li&gt;Released PVC已被删除，但是资源尚未回收&lt;/li&gt;
  &lt;li&gt;Failed 自动回收失败&lt;/li&gt;
&lt;/ul&gt;

&lt;h6 id=&quot;capacity&quot;&gt;Capacity&lt;/h6&gt;

&lt;p&gt;通常，我们在创建PV的时候，会从存储上给它划定一定大小的容量，这就使用capacity来指定即可。&lt;/p&gt;

&lt;h6 id=&quot;resource&quot;&gt;resource&lt;/h6&gt;

&lt;p&gt;pvc，就像pod一样，可以指定request资源的大小&lt;/p&gt;

&lt;h6 id=&quot;selector&quot;&gt;selector&lt;/h6&gt;

&lt;p&gt;PVC也可以指定标签选择器进行深度过滤PV，只有匹配了selector的PV才能绑定给PVC&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;matchLabels 单个匹配&lt;/li&gt;
  &lt;li&gt;matchExpressions 表达式匹配&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;namespace&quot;&gt;Namespace&lt;/h3&gt;

&lt;p&gt;Namespace一般用于实现多租户的资源隔离。namespace 通过将集群内部的资源分配到不同的Namespace中，形成逻辑上不同项目、小组或环境的隔离，同时利用resource quota实现资源的管控限制，而随着kubernetes访问控制的深入，namespace开始与kubernetes的认证和授权机制结合。&lt;/p&gt;

&lt;h3 id=&quot;annotation&quot;&gt;Annotation&lt;/h3&gt;

&lt;p&gt;annotation 和label类似，也是使用 key/value的形式进行定义。不同的是label具有严格的命名规则，它定义的是kubernetes对象的元数据，并且用于label selector，而annotation测试用户任意定义的”附加”信息，以便于外部工具进行查找，很多时候，kubernetes的模块会通过annotation的方式标记资源的特殊信息。&lt;/p&gt;</content><author><name>KevinGuo</name></author><summary type="html">入门概念</summary></entry><entry><title type="html">docker+consul+consul-template+registrator+nginx 的容器服务注册发现</title><link href="https://kevinguo.me/2017/09/01/docker-consul-consul-template-registrator-nginx/" rel="alternate" type="text/html" title="docker+consul+consul-template+registrator+nginx 的容器服务注册发现" /><published>2017-09-01T00:00:00+08:00</published><updated>2017-09-01T00:00:00+08:00</updated><id>https://kevinguo.me/2017/09/01/docker-consul-consul-template-registrator-nginx</id><content type="html" xml:base="https://kevinguo.me/2017/09/01/docker-consul-consul-template-registrator-nginx/">&lt;h3 id=&quot;前言&quot;&gt;前言&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;以前了解过一段时间的consul，只知道consul是一个服务发现的工具，但是具体是怎么注册的，又是怎么服务发现的，一点也不清楚，这次趁着研究kubernetes的服务发现，顺带研究了下consul，在此记录下来。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;概念&quot;&gt;概念&lt;/h3&gt;

&lt;p&gt;简单来说，consul是一个提供服务注册、服务发现、键值存储、健康检查的工具，并且它支持多数据中心。&lt;/p&gt;

&lt;p&gt;举个简单的例子，假若我们有一个暴露REST API的服务，为了高可用，我们决定为该服务提供3个服务实例，但是每个容器的地址和端口都是随机的，那么我们的服务之间怎么通信呢，我们又该怎么在前端LB上添加我们的后端服务呢？这时候就需要用到我们的服务发现工具consul了，其实还有很多其他的服务发现工具，比如etcd，zookeeper等等，这里我们重点说下consul。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;服务之间的通信，这个很简单，我们通过LB即可，所有的服务之间的互相访问，都通过LB即可，我们只需要确定每个服务对于的域名即可。&lt;/li&gt;
  &lt;li&gt;在LB上动态添加后端，这个通过consul-template+consul+registrator即可,consul-template会监控consul中的对应内容，然后根据consul模板文件生成新的配置&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;该实验所需的所有配置文件内容都放在我的&lt;a href=&quot;https://github.com/chinakevinguo/docker-consul.git&quot;&gt;Github&lt;/a&gt;上:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;该项目提供了一种简单的方法，使用consul-template将consul中的值生成具体所需的配置文件，并且实时监控consul，根据模板文件生成最新的配置文件，然后运行某些指定命令。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;由于环境有限，我下面所有的实验都是在一台机器上用docker完成，你只需要修改对应的IP地址即可&lt;/p&gt;

&lt;h3 id=&quot;consul&quot;&gt;Consul&lt;/h3&gt;

&lt;p&gt;提供服务注册和服务发现&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 注意这里我指定了-client是为了方便我通过外网访问consul ui&lt;/span&gt;

docker run -d --net&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;host --name consul -h consul -e &lt;span class=&quot;s1&quot;&gt;'CONSUL_LOCAL_CONFIG={&quot;skip_leave_on_interrupt&quot;: true}'&lt;/span&gt; consul agent -server -client &lt;span class=&quot;nv&quot;&gt;$HOST_IP&lt;/span&gt; -ui -bootstrap
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;registrator&quot;&gt;Registrator&lt;/h3&gt;

&lt;p&gt;将宿主机上的容器自动注册到consul中&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
docker run -d --net&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;host -v /var/run/docker.sock:/tmp/docker.sock --name registrator -h registrator gliderlabs/registrator:latest -internal consul://&lt;span class=&quot;nv&quot;&gt;$HOST_IP&lt;/span&gt;:8500
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;nginx-with-consul-template&quot;&gt;Nginx with consul-template&lt;/h3&gt;

&lt;p&gt;利用consul-template监控consul，根据模板生成新的配置，并提供负载均衡&lt;/p&gt;

&lt;p&gt;将上面地址中的内容clone到本地,build nginx-consul镜像&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://github.com/chinakevinguo/docker-consul.git
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;docker-consul
chmod +x start.sh
docker build -t docker-consul .
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;启动nginx&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run -p 8080:80 -d --name nginx -e &lt;span class=&quot;nv&quot;&gt;CONSUL_URL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$HOST_IP&lt;/span&gt;:8500 --volume ~/docker-consul/service.ctmpl:/templates/service.ctmpl  nginx-consul
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;启动一些服务实例&quot;&gt;启动一些服务实例&lt;/h3&gt;

&lt;p&gt;具体提供服务的实例&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run -d -P --name node1 -h node1 jlordiales/python-micro-service:latest
docker run -d -P --name node2 -h node2 jlordiales/python-micro-service:latest
docker run -d -P --name node3 -h node3 jlordiales/python-micro-service:latest
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;启动完成后，我们来看看nginx中是否已经动态添加了这些后端呢&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;docker &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; -ti nginx cat /etc/nginx/conf.d/service.conf
upstream python-service &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  least_conn;
  server 172.17.0.5:5000 &lt;span class=&quot;nv&quot;&gt;max_fails&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;3 &lt;span class=&quot;nv&quot;&gt;fail_timeout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;60 &lt;span class=&quot;nv&quot;&gt;weight&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1;
  server 172.17.0.6:5000 &lt;span class=&quot;nv&quot;&gt;max_fails&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;3 &lt;span class=&quot;nv&quot;&gt;fail_timeout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;60 &lt;span class=&quot;nv&quot;&gt;weight&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1;
  server 172.17.0.7:5000 &lt;span class=&quot;nv&quot;&gt;max_fails&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;3 &lt;span class=&quot;nv&quot;&gt;fail_timeout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;60 &lt;span class=&quot;nv&quot;&gt;weight&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1;
  server 172.17.0.8:5000 &lt;span class=&quot;nv&quot;&gt;max_fails&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;3 &lt;span class=&quot;nv&quot;&gt;fail_timeout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;60 &lt;span class=&quot;nv&quot;&gt;weight&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1;

&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

server &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  listen 80 default_server;

  charset utf-8;

  location /&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    proxy_pass http://python-service;
    proxy_set_header X-Forwarded-For &lt;span class=&quot;nv&quot;&gt;$proxy_add_x_forwarded_for&lt;/span&gt;;
    proxy_set_header Host &lt;span class=&quot;nv&quot;&gt;$host&lt;/span&gt;;
    proxy_set_header X-Real-IP &lt;span class=&quot;nv&quot;&gt;$remote_addr&lt;/span&gt;;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;然后我们来看看我们的consul ui中展现了那些内容呢&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/consul-ui.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;我们发现我们的python-micro-service 服务目前有4个，而且当我们通过如下命令访问的时候，也是4个轮询着被访问&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;while &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;; &lt;span class=&quot;k&quot;&gt;do &lt;/span&gt;curl &lt;span class=&quot;nv&quot;&gt;$HOST_IP&lt;/span&gt;:8080; &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; ----; sleep 1; &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;;
Hello World from node4----
Hello World from node1----
Hello World from node2----
Hello World from node3----
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;这时候，如果我马上停掉其中一个呢,我们发现consul ui中的服务也相应的减少，而且用命令访问的时候，也已经变成了3个&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/consul-ui-service.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;while &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;; &lt;span class=&quot;k&quot;&gt;do &lt;/span&gt;curl &lt;span class=&quot;nv&quot;&gt;$HOST_IP&lt;/span&gt;:8080; &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; ----; sleep 1; &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;;
Hello World from node1----
Hello World from node2----
Hello World from node3----
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h3&gt;

&lt;p&gt;文章写的比较简单，其实就是通过一个简单的实验，了解了下consul的服务注册，服务发现，以及如何使用consul-template来动态的生成对应的配置文件，而关于服务注册，我们使用的是registrator，也许你的项目需要调用consul的HTTP API来注册也说不定，具体你可以去&lt;a href=&quot;https://www.consul.io/&quot;&gt;consul官网&lt;/a&gt;了解更多。&lt;/p&gt;</content><author><name>KevinGuo</name></author><summary type="html">前言</summary></entry><entry><title type="html">Docker基础-理解容器之间的通信</title><link href="https://kevinguo.me/2017/08/23/Docker-container-communication/" rel="alternate" type="text/html" title="Docker基础-理解容器之间的通信" /><published>2017-08-23T00:00:00+08:00</published><updated>2017-08-23T00:00:00+08:00</updated><id>https://kevinguo.me/2017/08/23/Docker-container-communication</id><content type="html" xml:base="https://kevinguo.me/2017/08/23/Docker-container-communication/">&lt;p&gt;本节主要是讲解docker容器是如何在默认的&lt;code class=&quot;highlighter-rouge&quot;&gt;bridge&lt;/code&gt;网络上进行通信的。&lt;/p&gt;

&lt;!--more--&gt;

&lt;h3 id=&quot;和外网通信&quot;&gt;和外网通信&lt;/h3&gt;

&lt;p&gt;容器能否和外网进行通信，取决两个因素。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;主机上的&lt;code class=&quot;highlighter-rouge&quot;&gt;ip_forward&lt;/code&gt;是否打开，默认为true&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;iptables&lt;/code&gt;规则是否允许被修改，默认为true&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;如果在启动 Docker 服务的时候设定 –ip-forward=true, Docker 就会自动设定系统的 ip_forward 参数为 1。如果你的系统上打开了&lt;code class=&quot;highlighter-rouge&quot;&gt;ip_froward&lt;/code&gt;，而你在docker中设定&lt;code class=&quot;highlighter-rouge&quot;&gt;--ip-forward=flase&lt;/code&gt;，这不会起作用。&lt;/p&gt;

&lt;p&gt;关于&lt;code class=&quot;highlighter-rouge&quot;&gt;ip_froward&lt;/code&gt;的实验&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run -d --name  db  training/postgres

&lt;span class=&quot;c&quot;&gt;# 这时候首先去将ip_froward设置为false，发现无法ping通外网&lt;/span&gt;
 docker &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; -ti db ping www.baidu.com

&lt;span class=&quot;c&quot;&gt;# 这时候再将ip_forward设置为true，发现可以ping通外网&lt;/span&gt;
docker &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; -ti db ping www.baidu.com
PING www.a.shifen.com &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;103.235.46.39&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 56&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;84&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; bytes of data.
64 bytes from 103.235.46.39: &lt;span class=&quot;nv&quot;&gt;icmp_seq&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nv&quot;&gt;ttl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;54 &lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;56.3 ms
64 bytes from 103.235.46.39: &lt;span class=&quot;nv&quot;&gt;icmp_seq&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2 &lt;span class=&quot;nv&quot;&gt;ttl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;54 &lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;56.3 ms

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;默认情况下，docker会在启动容器的时候，在iptables中添加规则，如果你设定&lt;code class=&quot;highlighter-rouge&quot;&gt;--iptables=false&lt;/code&gt;，docker将不会修改你的防火墙规则。&lt;/p&gt;

&lt;p&gt;关于&lt;code class=&quot;highlighter-rouge&quot;&gt;--iptables&lt;/code&gt;的实验&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 首先，确认下有没有关于docker0的防火墙规则，有就删除掉&lt;/span&gt;
iptables -S |grep docker0

&lt;span class=&quot;c&quot;&gt;# 然后测试ping外网，发现无法ping通&lt;/span&gt;
docker &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; -ti db ping www.baidu.com

&lt;span class=&quot;c&quot;&gt;# 这时候将iptables改为true，查看防火墙规则，又添加了关于docker0的规则&lt;/span&gt;
iptables -S |grep docker
-A FORWARD -o docker0 -j DOCKER
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i docker0 ! -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT

&lt;span class=&quot;c&quot;&gt;# 测试发现能ping通外网&lt;/span&gt;

docker &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; -ti db ping www.baidu.com
PING www.a.shifen.com &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;103.235.46.39&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 56&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;84&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; bytes of data.
64 bytes from 103.235.46.39: &lt;span class=&quot;nv&quot;&gt;icmp_seq&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nv&quot;&gt;ttl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;54 &lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;56.3 ms
64 bytes from 103.235.46.39: &lt;span class=&quot;nv&quot;&gt;icmp_seq&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2 &lt;span class=&quot;nv&quot;&gt;ttl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;54 &lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;56.3 ms
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;默认情况下，容器可以和任何外部地址进行通信。除非你设定仅仅只有那些地址可以访问内部的容器。如下，设定只有8.8.8.8能访问内部容器&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;iptables -I DOCKER -i ext_if ! -s 8.8.8.8 -j DROP
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;容器之间通信&quot;&gt;容器之间通信&lt;/h3&gt;

&lt;p&gt;容器之间是否能进行通信，取决于系统层面的两个因素。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;容器网络是否连接到&lt;code class=&quot;highlighter-rouge&quot;&gt;docker0&lt;/code&gt;网络，默认是连接到docker0&lt;/li&gt;
  &lt;li&gt;你的&lt;code class=&quot;highlighter-rouge&quot;&gt;iptables&lt;/code&gt;是否允许被修改，默认为true,你的&lt;code class=&quot;highlighter-rouge&quot;&gt;--icc&lt;/code&gt;状态，默认为true&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;注意：如果你使用默认的&lt;code class=&quot;highlighter-rouge&quot;&gt;iptables=true&lt;/code&gt;，则当&lt;code class=&quot;highlighter-rouge&quot;&gt;--icc=true&lt;/code&gt;时会添加 ACCEPT 规则，当&lt;code class=&quot;highlighter-rouge&quot;&gt;--icc=false&lt;/code&gt;时会添加 DROP 规则; 当然如果你的&lt;code class=&quot;highlighter-rouge&quot;&gt;iptables=false&lt;/code&gt;则无所谓了，反正不会修改你的防火墙规则&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;关于&lt;code class=&quot;highlighter-rouge&quot;&gt;--icc&lt;/code&gt;的实验&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 设置--icc=false发现容器之间无法ping通,如果你发现你依然能ping通，那可能是前面的防火墙配置，执行iptables -F 清空下再试&lt;/span&gt;
docker &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; -ti db ping 172.17.0.3


&lt;span class=&quot;c&quot;&gt;# 设置--icc=true发现容器之间可以ping通&lt;/span&gt;
docker &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; -ti db ping 172.17.0.3
PING 172.17.0.3 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;172.17.0.3&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 56&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;84&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; bytes of data.
64 bytes from 172.17.0.3: &lt;span class=&quot;nv&quot;&gt;icmp_seq&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nv&quot;&gt;ttl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;64 &lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0.128 ms
64 bytes from 172.17.0.3: &lt;span class=&quot;nv&quot;&gt;icmp_seq&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2 &lt;span class=&quot;nv&quot;&gt;ttl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;64 &lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0.110 ms
64 bytes from 172.17.0.3: &lt;span class=&quot;nv&quot;&gt;icmp_seq&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;3 &lt;span class=&quot;nv&quot;&gt;ttl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;64 &lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0.096 ms

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;注意：所以，我们启动docker之前，就要确定好，到底是否需要允许docker修改iptables，是否允许容器之间通信，是否允许容器访问外网等&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;主机之间的容器通信&quot;&gt;主机之间的容器通信&lt;/h3&gt;

&lt;p&gt;官网上说的是将默认FORWARD DROP策略改为 ACCEPT，其实没那个必要，使用overlay网络就好了,比如:flannel,weave,calico等等…&lt;/p&gt;</content><author><name>KevinGuo</name></author><summary type="html">本节主要是讲解docker容器是如何在默认的bridge网络上进行通信的。</summary></entry><entry><title type="html">High Availability Ranchers for docker hosts</title><link href="https://kevinguo.me/2017/08/22/Rancher-for-docker-hosts/" rel="alternate" type="text/html" title="High Availability Ranchers for docker hosts" /><published>2017-08-22T00:00:00+08:00</published><updated>2017-08-22T00:00:00+08:00</updated><id>https://kevinguo.me/2017/08/22/Rancher-for-docker-hosts</id><content type="html" xml:base="https://kevinguo.me/2017/08/22/Rancher-for-docker-hosts/">&lt;h3 id=&quot;前言&quot;&gt;前言&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;由于公司目前有部分业务跑在docker上，但又还没有上诸如:swarm,kubernetes之类的容器编排工具，但是又想要能对docker主机及容器进行一个简单可视化的管理，筛选来，筛选去，发现无论是:DockerUI、Shipyard、portainer还是Daocloud都不能符合我们的心意，最终决定使用&lt;code class=&quot;highlighter-rouge&quot;&gt;rancher&lt;/code&gt;来进行管理。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;rancher是什么&quot;&gt;Rancher是什么&lt;/h3&gt;

&lt;p&gt;借用官方文档里面的话来说，Rancher是一个开源的容器管理平台。&lt;/p&gt;

&lt;p&gt;实际上Rancher能够整合目前市面上大多数的容器编排工具，如：swarm、kubernetes、mesos等，而且，它本身最拥有一个最基础的编排工具cattle，本次我们使用的就是它的cattle编排器。&lt;/p&gt;

&lt;h3 id=&quot;环境准备&quot;&gt;环境准备&lt;/h3&gt;

&lt;p&gt;所有系统均为&lt;code class=&quot;highlighter-rouge&quot;&gt;CentOS 7.2&lt;/code&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;IP&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;ROLE&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;172.30.33.44&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Rancher Server 01&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;172.30.33.45&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Rancher Server 02&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;172.30.33.227&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;External MySQL Server&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;172.30.33.183&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Nginx LB&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;所需镜像如下&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;IMAGE&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;VERSION&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;rancher/server&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;latest&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;rancher/agent&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;v1.2.5&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;rancher/scheduler&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;v0.8.2&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;rancher/healthcheck&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;v0.3.1&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;rancher/dns&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;v0.15.1&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;rancher/metadata&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;v0.9.3&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;rancher/net&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;v0.11.7&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;rancher/net&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;holder&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;rancher/network-manager&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;v0.7.7&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;rancher-server&quot;&gt;Rancher Server&lt;/h3&gt;

&lt;h5 id=&quot;ecternal-mysql-server&quot;&gt;Ecternal mySQL Server&lt;/h5&gt;

&lt;p&gt;使用如下命令，创建&lt;code class=&quot;highlighter-rouge&quot;&gt;cattle&lt;/code&gt;数据库和&lt;code class=&quot;highlighter-rouge&quot;&gt;cattle&lt;/code&gt;用户&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;CREATE DATABASE IF NOT EXISTS cattle COLLATE &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'utf8_general_ci'&lt;/span&gt; CHARACTER SET &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'utf8'&lt;/span&gt;;
GRANT ALL ON cattle.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; TO &lt;span class=&quot;s1&quot;&gt;'cattle'&lt;/span&gt;@&lt;span class=&quot;s1&quot;&gt;'%'&lt;/span&gt; IDENTIFIED BY &lt;span class=&quot;s1&quot;&gt;'cattle'&lt;/span&gt;;
GRANT ALL ON cattle.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; TO &lt;span class=&quot;s1&quot;&gt;'cattle'&lt;/span&gt;@&lt;span class=&quot;s1&quot;&gt;'localhost'&lt;/span&gt; IDENTIFIED BY &lt;span class=&quot;s1&quot;&gt;'cattle'&lt;/span&gt;;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h5 id=&quot;rancher-server-1&quot;&gt;Rancher Server&lt;/h5&gt;

&lt;p&gt;在每台Node上执行如下命令&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run -d --restart&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;unless-stopped -p 8080:8080 -p 9345:9345 rancher/server &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
     --db-host myhost.example.com --db-port 3306 --db-user username --db-pass password --db-name cattle &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
     --advertise-address &amp;lt;IP_of_the_Node&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;注意：&lt;/strong&gt; 如果你改变了&lt;code class=&quot;highlighter-rouge&quot;&gt;-p 8080:8080&lt;/code&gt;端口，则需要额外添加一个参数&lt;code class=&quot;highlighter-rouge&quot;&gt;--addvertise-http-port &amp;lt;host_port&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h5 id=&quot;nginx-lb&quot;&gt;Nginx LB&lt;/h5&gt;

&lt;p&gt;在nginx的Vhost中添加如下两个文件&lt;/p&gt;

&lt;p&gt;rancher-upstream.conf&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;upstream rancher-server &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        server 172.30.33.44:8080;
        server 172.30.33.45:8080;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
map &lt;span class=&quot;nv&quot;&gt;$http_upgrade&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$connection_upgrade&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    default Upgrade;
    &lt;span class=&quot;s1&quot;&gt;''&lt;/span&gt;      close;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;         
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;rancher.conf&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;server &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        listen 80;
        server_name rancher.quark.com;

        access_log  logs/rancher_access.log main;
        location / &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;c&quot;&gt;#internal;&lt;/span&gt;
        proxy_set_header Host &lt;span class=&quot;nv&quot;&gt;$host&lt;/span&gt;;
        proxy_set_header X-Forwarded-Proto &lt;span class=&quot;nv&quot;&gt;$scheme&lt;/span&gt;;
        proxy_set_header X-Forwarded-Port &lt;span class=&quot;nv&quot;&gt;$server_port&lt;/span&gt;;
        proxy_set_header X-Forwarded-For &lt;span class=&quot;nv&quot;&gt;$proxy_add_x_forwarded_for&lt;/span&gt;;
        proxy_pass http://rancher-server;
        proxy_http_version 1.1;
        proxy_set_header Upgrade &lt;span class=&quot;nv&quot;&gt;$http_upgrade&lt;/span&gt;;
        proxy_set_header Connection &lt;span class=&quot;nv&quot;&gt;$connection_upgrade&lt;/span&gt;;
        proxy_read_timeout 900s;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;       
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;rancher-agent&quot;&gt;Rancher agent&lt;/h3&gt;

&lt;p&gt;上面的步骤完成后，我们来访问我们的rancher ui，然后来添加host
&lt;img src=&quot;/images/posts/rancher-add-agent.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;依次添加完你的docker host之后，如下图
&lt;img src=&quot;/images/posts/rancher-ui.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;后记&quot;&gt;后记&lt;/h3&gt;

&lt;p&gt;rancher上还有很多功能，感兴趣的同学可以去自行研究下，我这里只是一个临时的需求，所以就不做过多的实例了。&lt;/p&gt;</content><author><name>KevinGuo</name></author><summary type="html">前言</summary></entry><entry><title type="html">jekyll 搭建静态博客之https番外篇</title><link href="https://kevinguo.me/2017/07/13/jekyll-create-a-static-blog(3)/" rel="alternate" type="text/html" title="jekyll 搭建静态博客之https番外篇" /><published>2017-07-13T00:00:00+08:00</published><updated>2017-07-13T00:00:00+08:00</updated><id>https://kevinguo.me/2017/07/13/jekyll-create-a-static-blog(3)</id><content type="html" xml:base="https://kevinguo.me/2017/07/13/jekyll-create-a-static-blog(3)/">&lt;blockquote&gt;
  &lt;p&gt;上一篇HTTPS是使用cloudflare进行加密的，所有的请求都交给cloudflare来进行转发，就会出现域名指向的IP不是主机的问题，虽然安全些，但是总感觉怪怪的，所以这一篇，直接通过 nginx+docker+let’s encrypt 搭建HTTPS认证&lt;/p&gt;
&lt;/blockquote&gt;

&lt;!--more--&gt;
&lt;h3 id=&quot;前提&quot;&gt;前提&lt;/h3&gt;

&lt;p&gt;首先记得将 cloudflare 上有关你的站点的https配置删掉，如果没有做过，则忽略，同时记得去你的 DNS 控制器上将你的域名解析改为默认&lt;/p&gt;

&lt;h3 id=&quot;搭建过程&quot;&gt;搭建过程&lt;/h3&gt;

&lt;p&gt;搭建过程比较简单&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;准备好你前端的 nginx 服务器&lt;/li&gt;
  &lt;li&gt;准备好你后端的 docker 容器&lt;/li&gt;
  &lt;li&gt;clone let’s encrypt 到服务器&lt;/li&gt;
  &lt;li&gt;生成证书&lt;/li&gt;
  &lt;li&gt;配置你的 nginx&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;1.准备 nginx&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;yum update

yum install nginx
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;2.clone let’s encrypt 到服务器&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://github.com/certbot/certbot.git
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;3.准备 docker 容器&lt;/p&gt;

&lt;p&gt;一条命令即可&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run -d --name chinakevinguo_jekyll_kevinguo_me --restart&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;always -p 127.0.0.1:1080:80 chinakevinguo_jekyll_kevinguo_me
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;4.生成证书&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意：如果你开了防火墙，记得一定要将防火墙关闭，否则生成证书的时候可能会报错&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl stop firewalld

&lt;span class=&quot;c&quot;&gt;# 将这里的域名，换成你自己的域名&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;certbot
./certbot-auto certonly --nginx -d kevinguo.me -d www.kevinguo.me
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;成功后，内容如下&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at
   /etc/letsencrypt/live/kevinguo.me/fullchain.pem. Your cert will
   expire on 2017-10-11. To obtain a new or tweaked version of this
   certificate &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;the future, simply run certbot-auto again. To
   non-interactively renew &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;all&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; of your certificates, run
   certbot-auto renew
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Lets Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;然后生成&lt;code class=&quot;highlighter-rouge&quot;&gt;dhparam&lt;/code&gt;证书，可能会花费一段时间&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;openssl dhparam -out /etc/letsencrypt/live/kevinguo.me/dhparam.pem 2048
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;5.配置你的 nginx&lt;/p&gt;

&lt;p&gt;nginx 的配置尽量模块化，这里通过 nginx 作为代理，访问后端的 docker 容器&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;nginx.conf&lt;/strong&gt; 内容如下&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;user nginx;
worker_processes auto;
pid /run/nginx.pid;

&lt;span class=&quot;c&quot;&gt;# Load dynamic modules. See /usr/share/nginx/README.dynamic.&lt;/span&gt;
include /usr/share/nginx/modules/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.conf;

events &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    use epoll;
    worker_connections 1024;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

http &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    server_tokens off;
    log_format  main  &lt;span class=&quot;s1&quot;&gt;'$remote_addr||$time_local||&quot;$request&quot;||'&lt;/span&gt;
                      &lt;span class=&quot;s1&quot;&gt;'$status||$body_bytes_sent||&quot;$http_referer&quot;'&lt;/span&gt;
                      &lt;span class=&quot;s1&quot;&gt;'||$http_x_forwarded_for||'&lt;/span&gt;
                      &lt;span class=&quot;s1&quot;&gt;'||$upstream_status||$upstream_addr||$request_time||$upstream_response_time||'&lt;/span&gt; ;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    gzip on;
    gzip_disable &lt;span class=&quot;s2&quot;&gt;&quot;msie6&quot;&lt;/span&gt;;
    gzip_proxied any;
    gzip_min_length 1000;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

    include /etc/nginx/conf.d/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.conf;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;对应站点.conf&lt;/strong&gt; 内容如下&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;upstream chinakevinguo_jekyll_kevinguo_me &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    server 127.0.0.1:1080;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
server &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    listen 80 default_server;
    listen &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;::]:80 default_server;
    server_name kevinguo.me www.kevinguo.me;

    &lt;span class=&quot;c&quot;&gt;# Redirect all HTTP requests to HTTPS with a 301 Moved Permanently response.&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;301 https://&lt;span class=&quot;nv&quot;&gt;$server_name$request_uri&lt;/span&gt;;
    &lt;span class=&quot;c&quot;&gt;#return 404;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

server &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    listen 443 ssl http2 default_server;
    listen &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;::]:443 ssl http2 default_server;
    server_name kevinguo.me www.kevinguo.me;

    &lt;span class=&quot;c&quot;&gt;# certs sent to the client in SERVER HELLO are concatenated in ssl_certificate&lt;/span&gt;
    ssl_certificate /etc/letsencrypt/live/kevinguo.me/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/kevinguo.me/privkey.pem;
    ssl_dhparam /etc/letsencrypt/live/kevinguo.me/dhparam.pem;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers &lt;span class=&quot;s1&quot;&gt;'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS'&lt;/span&gt;;
    ssl_prefer_server_ciphers on;
    ssl_stapling on;
    ssl_stapling_verify on;
    &lt;span class=&quot;c&quot;&gt;# HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)&lt;/span&gt;
    add_header Strict-Transport-Security max-age&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;15768000;


    add_header X-Frame-Options DENY;
    add_header  X-Content-Type-Options  nosniff;
    add_header X-XSS-Protection &lt;span class=&quot;s2&quot;&gt;&quot;1&quot;&lt;/span&gt;;
    access_log /var/log/nginx/chinakevinguo_jekyll_kevinguo_me_access.log ;
    error_log /var/log/nginx/chinakevinguo_jekyll_kevinguo_me_error.log ;

    location / &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
       root html;
       index index.html;
       proxy_pass         http://chinakevinguo_jekyll_kevinguo_me;
       proxy_set_header   Host             &lt;span class=&quot;nv&quot;&gt;$host&lt;/span&gt;:443;
       proxy_set_header   X-Real-IP        &lt;span class=&quot;nv&quot;&gt;$remote_addr&lt;/span&gt;;
       proxy_set_header   X-Forwarded-For  &lt;span class=&quot;nv&quot;&gt;$proxy_add_x_forwarded_for&lt;/span&gt;;
       proxy_connect_timeout   10s;
       proxy_send_timeout      100s;
       proxy_read_timeout      300s;
       proxy_next_upstream error timeout http_404;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;最后，来访问试试看呢&lt;/p&gt;</content><author><name>KevinGuo</name></author><summary type="html">上一篇HTTPS是使用cloudflare进行加密的，所有的请求都交给cloudflare来进行转发，就会出现域名指向的IP不是主机的问题，虽然安全些，但是总感觉怪怪的，所以这一篇，直接通过 nginx+docker+let’s encrypt 搭建HTTPS认证</summary></entry><entry><title type="html">jekyll 搭建静态博客(2)</title><link href="https://kevinguo.me/2017/07/12/jekyll-create-a-static-blog(2)/" rel="alternate" type="text/html" title="jekyll 搭建静态博客(2)" /><published>2017-07-12T00:00:00+08:00</published><updated>2017-07-12T00:00:00+08:00</updated><id>https://kevinguo.me/2017/07/12/jekyll-create-a-static-blog(2)</id><content type="html" xml:base="https://kevinguo.me/2017/07/12/jekyll-create-a-static-blog(2)/">&lt;blockquote&gt;
  &lt;p&gt;接上一篇，上一篇我们的博客已经可以自动化部署了，但是我们仍然不满足，还想要有一个好的评论系统和一个安全的https连接&lt;/p&gt;
&lt;/blockquote&gt;

&lt;!--more--&gt;

&lt;h3 id=&quot;disqus&quot;&gt;Disqus&lt;/h3&gt;

&lt;p&gt;disqus 是一家第三方社会化评论系统，主要为网站主提供评论托管服务&lt;/p&gt;

&lt;p&gt;1.在&lt;a href=&quot;https://disqus.com/&quot;&gt;disqus官网&lt;/a&gt;注册一个账号&lt;/p&gt;

&lt;p&gt;2.点击&lt;code class=&quot;highlighter-rouge&quot;&gt;Admin&lt;/code&gt;，然后新建站点，在&lt;code class=&quot;highlighter-rouge&quot;&gt;Website Name&lt;/code&gt;处输入你的站点名称，并且根据你的情况选择站点种类&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/disqus-create.png&quot; alt=&quot;disqus-create&quot; /&gt;&lt;/p&gt;

&lt;p&gt;3.在&lt;code class=&quot;highlighter-rouge&quot;&gt;Website URL&lt;/code&gt;处输入你的站点 url，保存即可&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/disqus-conf.png&quot; alt=&quot;disqus-conf&quot; /&gt;&lt;/p&gt;

&lt;p&gt;4.修改你的&lt;code class=&quot;highlighter-rouge&quot;&gt;_config.yml&lt;/code&gt;文件中的 &lt;code class=&quot;highlighter-rouge&quot;&gt;comments_provider&lt;/code&gt; 和 &lt;code class=&quot;highlighter-rouge&quot;&gt;username&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;重要： 这里的&lt;code class=&quot;highlighter-rouge&quot;&gt;username&lt;/code&gt;，实际上是 disqus 中的shortname&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;comments_provider: disqus
disqus:
    username: kevinguo
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;5.修改完成后，push 到镜像站点，触发 Travis CI 重新发布博客，最终成功加载 disqus&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/disqus-done.png&quot; alt=&quot;disqus-done&quot; /&gt;&lt;/p&gt;

&lt;p&gt;如果无法加载 disqus ，可能是因为被墙了，FQ 出去试试&lt;/p&gt;

&lt;h3 id=&quot;cloudflare&quot;&gt;Cloudflare&lt;/h3&gt;

&lt;p&gt;cloudflare 主要是为客户提供网站安全管理，性能优化等，比如 &lt;code class=&quot;highlighter-rouge&quot;&gt;HTTPS&lt;/code&gt;,&lt;code class=&quot;highlighter-rouge&quot;&gt;CDN&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;1.在&lt;a href=&quot;https://sg.godaddy.com/zh/&quot;&gt;godaddy&lt;/a&gt;上去申请一个域名吧，一年也就 5$&lt;/p&gt;

&lt;p&gt;2.在&lt;a href=&quot;https://www.cloudflare.com&quot;&gt;cloudflare官网&lt;/a&gt;注册一个账号&lt;/p&gt;

&lt;p&gt;3.点击 &lt;code class=&quot;highlighter-rouge&quot;&gt;Add Site&lt;/code&gt;，添加一个站点，然后 &lt;code class=&quot;highlighter-rouge&quot;&gt;Begin Scan&lt;/code&gt;,大概需要60s&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/cloudflare-add.png&quot; alt=&quot;cloudflare-add&quot; /&gt;&lt;/p&gt;

&lt;p&gt;4.扫描完成后，会看到 DNS 记录，自行添加(其中彩色的云朵表示开启SSL，否则就只是DNS)&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意 如果你的A记录启用的SSL，那么所有关于这个A记录的请求都会转发给 Cloudflare，然后通过 Cloudflare再转发到你的服务器，所以这个时候，你通过 &lt;code class=&quot;highlighter-rouge&quot;&gt;nslookup kevinguo.me&lt;/code&gt; 的时候解析出来的地址，并不是你的服务器地址，而是 Cloudflare的地址;如果你有其他服务(诸如VPS,FTP等)使用的是这个地址的话，最好是再添加一条不走SSL的A记录&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/cloudflare-dns.png&quot; alt=&quot;cloudflare-dns&quot; /&gt;&lt;/p&gt;

&lt;p&gt;5.完成上面的步骤后，到你的域名控制面板修改DNS服务&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/godaddy-dns.png&quot; alt=&quot;godaddy-dns&quot; /&gt;&lt;/p&gt;

&lt;p&gt;6.修改完成后，在 Cloudflare点击继续，大概5~30分钟后 &lt;code class=&quot;highlighter-rouge&quot;&gt;Overview&lt;/code&gt; 状态会变成 &lt;code class=&quot;highlighter-rouge&quot;&gt;Status: Active&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/cloudflare-status.png&quot; alt=&quot;cloudflare-status&quot; /&gt;&lt;/p&gt;

&lt;p&gt;7.点击 &lt;code class=&quot;highlighter-rouge&quot;&gt;Crypto&lt;/code&gt;来设置SSL 级别&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/cloudflare-ssl.png&quot; alt=&quot;cloudflare-ssl&quot; /&gt;&lt;/p&gt;

&lt;p&gt;8.点击 &lt;code class=&quot;highlighter-rouge&quot;&gt;Page Rules&lt;/code&gt;来设置域名重定向&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;将顶级域名都重定向到 &lt;code class=&quot;highlighter-rouge&quot;&gt;https://www.kevinguo.me&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/cloudflare-forwarding.png&quot; alt=&quot;cloudflare-forwarding&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;添加自动使用 HTTPS，所有访问&lt;code class=&quot;highlighter-rouge&quot;&gt;http://www.kevinguo.me&lt;/code&gt;的请求都使用HTTPS&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/cloudflare-always-https.png&quot; alt=&quot;cloudflare-always-https&quot; /&gt;&lt;/p&gt;

&lt;p&gt;9.最后，访问你的blog试试呢&lt;/p&gt;</content><author><name>KevinGuo</name></author><summary type="html">接上一篇，上一篇我们的博客已经可以自动化部署了，但是我们仍然不满足，还想要有一个好的评论系统和一个安全的https连接</summary></entry><entry><title type="html">jekyll 搭建静态博客(1)</title><link href="https://kevinguo.me/2017/07/12/jekyll-create-a-static-blog(1)/" rel="alternate" type="text/html" title="jekyll 搭建静态博客(1)" /><published>2017-07-12T00:00:00+08:00</published><updated>2017-07-12T00:00:00+08:00</updated><id>https://kevinguo.me/2017/07/12/jekyll-create-a-static-blog(1)</id><content type="html" xml:base="https://kevinguo.me/2017/07/12/jekyll-create-a-static-blog(1)/">&lt;blockquote&gt;
  &lt;p&gt;这段时间将原来在hexo上的博客迁到了jekyll上；采用Jekyll生成静态站点，Travis CI自动化部署，记录下来，以免以后忘记了&lt;/p&gt;
&lt;/blockquote&gt;

&lt;!--more--&gt;

&lt;h3 id=&quot;整体思路&quot;&gt;整体思路&lt;/h3&gt;

&lt;p&gt;我们都知道通过jekyll搭建博客最终都是将通过&lt;code class=&quot;highlighter-rouge&quot;&gt;jekyll build&lt;/code&gt;生成的&lt;code class=&quot;highlighter-rouge&quot;&gt;_site&lt;/code&gt;下的静态文件发布出去，那么我们是不是可以直接采用 &lt;code class=&quot;highlighter-rouge&quot;&gt;nginx&lt;/code&gt; + &lt;code class=&quot;highlighter-rouge&quot;&gt;静态文件&lt;/code&gt;的方式来发布呢，当然是可以的&lt;/p&gt;

&lt;h4 id=&quot;准备两个站点仓库&quot;&gt;准备两个站点仓库&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;主站点Github (保存静态文件)&lt;/li&gt;
  &lt;li&gt;镜像站点Github (触发 travis ，生成静态文件)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;我们只需要将 Travis CI生成的静态文件推送到 主站点Github，博客通过 docker 化部署，采用 &lt;code class=&quot;highlighter-rouge&quot;&gt;nginx&lt;/code&gt; + &lt;code class=&quot;highlighter-rouge&quot;&gt;静态文件&lt;/code&gt; 方式；每次容器启动后都要从主站点Github pull 最新的静态文件，流程如下&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;本地提交博客 Markdown 文件到镜像站点Github&lt;/li&gt;
  &lt;li&gt;Github 触发 Travis CI 执行jekyll 编译&lt;/li&gt;
  &lt;li&gt;Travis CI 将编译后的静态文件push到主站点Github&lt;/li&gt;
  &lt;li&gt;Travis CI 通知服务器重启容器&lt;/li&gt;
  &lt;li&gt;容器重启拉去最新静态文件完成更新&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;https://travis-ci.org/&quot;&gt;Travis&lt;/a&gt; 是啥？ 就是个类似jenkins的东西. &lt;a href=&quot;https://jenkins.io/&quot;&gt;Jenkins&lt;/a&gt; 是啥？ 就是个类似Travis的东西.&lt;/p&gt;

&lt;h4 id=&quot;构建所需docker镜像&quot;&gt;构建所需docker镜像&lt;/h4&gt;

&lt;p&gt;既然博客是通过 docker 化部署，采用&lt;code class=&quot;highlighter-rouge&quot;&gt;nginx&lt;/code&gt; + &lt;code class=&quot;highlighter-rouge&quot;&gt;静态文件&lt;/code&gt; 的方式发布，那么我们第一步就是要构建我们博客所需的镜像，&lt;code class=&quot;highlighter-rouge&quot;&gt;Dockerfile&lt;/code&gt; 内容如下&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;FROM nginx:1.11.10-alpine

MAINTAINER KevinGuo &lt;span class=&quot;s2&quot;&gt;&quot;chinakevinguo@live.com&quot;&lt;/span&gt;

ENV TZ &lt;span class=&quot;s1&quot;&gt;'Asia/Shanghai'&lt;/span&gt;

RUN apk upgrade --no-cache &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; apk add --no-cache bash git &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; rm -rf /usr/share/nginx/html &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; git clone https://github.com/chinakevinguo/kevinguo.me.git /usr/share/nginx/html &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Asia/Shanghai&quot;&lt;/span&gt; &amp;gt; /etc/timezone &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; rm -rf /var/cache/apk/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;

ADD entrypoint.sh /entrypoint.sh

WORKDIR /usr/share/nginx/html

CMD &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/entrypoint.sh&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;容器每次重启的时候都会去主站点Github上拉取最新的静态文件，并且启动 nginx，&lt;code class=&quot;highlighter-rouge&quot;&gt;entrypoint.sh&lt;/code&gt;内容如下&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;

git pull
nginx -g &lt;span class=&quot;s2&quot;&gt;&quot;daemon off;&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;最后执行&lt;code class=&quot;highlighter-rouge&quot;&gt;docker build&lt;/code&gt;，生成我们所需的镜像&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker build -t chinakevinguo_jekyll_kevinguo_me .
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;博客所需镜像制作完成后，启动容器&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run -d --name chinakevinguo_jekyll_kevinguo_me --restart&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;always -p 80:80 -p 443:443 chinakevinguo_jekyll_kevinguo_me
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;下一步就是 &lt;code class=&quot;highlighter-rouge&quot;&gt;静态文件&lt;/code&gt; 了&lt;/p&gt;

&lt;h4 id=&quot;静态文件的自动更新&quot;&gt;静态文件的自动更新&lt;/h4&gt;

&lt;p&gt;通过上面 &lt;code class=&quot;highlighter-rouge&quot;&gt;Dockerfile&lt;/code&gt; 文件中的内容，你会发现，我是将 &lt;code class=&quot;highlighter-rouge&quot;&gt;kevinguo.me.git&lt;/code&gt;下的内容clone到 &lt;code class=&quot;highlighter-rouge&quot;&gt;/usr/share/nginx/html&lt;/code&gt;，也就是说，我实际上是发布的 &lt;code class=&quot;highlighter-rouge&quot;&gt;kevinguo.me.git&lt;/code&gt; 下的静态文件，那么 &lt;code class=&quot;highlighter-rouge&quot;&gt;kevinguo.me.git&lt;/code&gt; 下面的内容又是怎么来的呢&lt;/p&gt;

&lt;p&gt;实际上这些文件是 Travis CI 基于镜像站点(chinakevinguo.github.io) 完成 build 后在 &lt;code class=&quot;highlighter-rouge&quot;&gt;_site&lt;/code&gt;目录下生成的镜像文件&lt;/p&gt;

&lt;h5 id=&quot;travis-配置&quot;&gt;Travis 配置&lt;/h5&gt;

&lt;p&gt;1.使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;Github&lt;/code&gt; 账号登录 Travis，右上方按钮点击同步项目，下方打开需要继承的项目，最后点击齿轮进入项目配置页面&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis.png&quot; alt=&quot;travis&quot; /&gt;&lt;/p&gt;

&lt;p&gt;2.打开 &lt;code class=&quot;highlighter-rouge&quot;&gt;Build only if .travis.yml is present&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis-yml.png&quot; alt=&quot;travis-yml&quot; /&gt;&lt;/p&gt;

&lt;p&gt;3.Travis CI push静态文件到Github 通过 Github的token实现授权配置，准备 Github上的token&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意： 这里的&lt;code class=&quot;highlighter-rouge&quot;&gt;token&lt;/code&gt;，复制之后，最好自己保存好哟，因为只显示一次，如果丢失只能再次生成了&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/github-token.png&quot; alt=&quot;github-token.png&quot; /&gt;&lt;/p&gt;

&lt;p&gt;4.配置Travis CI 部署所需环境变量，&lt;code class=&quot;highlighter-rouge&quot;&gt;$JEKYLL_GITHUB_TOKEN&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis-token.png&quot; alt=&quot;travis-token&quot; /&gt;&lt;/p&gt;

&lt;p&gt;5.Travis CI 和服务器之间通过密钥认证，并且对密钥进行了加密，所以我们需要在服务器上进行一些加密操作，并将密钥传到Travis上&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# clone 镜像站点&lt;/span&gt;
git clone git@github.com:chinakevinguo/chinakevinguo.github.io.git

&lt;span class=&quot;c&quot;&gt;# 在镜像站点(chinakevinguo.github.io)下，新建`.travis.yml`文件&lt;/span&gt;
touch .travis.yml

&lt;span class=&quot;c&quot;&gt;# 生成公钥和私钥&lt;/span&gt;
ssh-keygen

&lt;span class=&quot;c&quot;&gt;# 安装travis命令行工具，如无法使用gem指令需先安装ruby&lt;/span&gt;
gem install travis

&lt;span class=&quot;c&quot;&gt;# --auto自动登录github账户&lt;/span&gt;
travis login --auto

&lt;span class=&quot;c&quot;&gt;# 在.travis.yml同级目录下执行，此处的--add参数表示自动添加脚本到.travis.yml文件中&lt;/span&gt;
travis encrypt-file ~/.ssh/id_rsa --add

&lt;span class=&quot;c&quot;&gt;# 在服务器上执行ssh-copy-id操作，实现ssh连接的时候免密钥登陆&lt;/span&gt;
ssh-copy-id root@kevinguo.me
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;执行完成后会发现&lt;code class=&quot;highlighter-rouge&quot;&gt;travis&lt;/code&gt;网站项目里的环境变量多了两个参数&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis-key.png&quot; alt=&quot;travis-key&quot; /&gt;&lt;/p&gt;

&lt;p&gt;并且在&lt;code class=&quot;highlighter-rouge&quot;&gt;.travis.yml&lt;/code&gt;里的 &lt;code class=&quot;highlighter-rouge&quot;&gt;before_install&lt;/code&gt;周期中多了下面2行&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;- openssl aes-256-cbc -K &lt;span class=&quot;nv&quot;&gt;$encrypted_3870315c7a22_key&lt;/span&gt; -iv &lt;span class=&quot;nv&quot;&gt;$encrypted_3870315c7a22_iv&lt;/span&gt;
  -in id_rsa.enc -out ~&lt;span class=&quot;se&quot;&gt;\/&lt;/span&gt;.ssh/id_rsa -d
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;默认生成的命令会在&lt;code class=&quot;highlighter-rouge&quot;&gt;/&lt;/code&gt;前面带转义符&lt;code class=&quot;highlighter-rouge&quot;&gt;\&lt;/code&gt;，我们不需要，手动删除即可&lt;/p&gt;

&lt;p&gt;6.进一步修改 &lt;code class=&quot;highlighter-rouge&quot;&gt;.travis.yml&lt;/code&gt; 文件，内容如下&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;language: ruby
rvm:
- 2.3.3
before_install:
- openssl aes-256-cbc -K &lt;span class=&quot;nv&quot;&gt;$encrypted_3870315c7a22_key&lt;/span&gt; -iv &lt;span class=&quot;nv&quot;&gt;$encrypted_3870315c7a22_iv&lt;/span&gt; -in id_rsa.enc -out ~/.ssh/id_rsa -d
- chmod 600 ~/.ssh/id_rsa
- &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;Host 主机IP地址&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n\t&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;StrictHostKeyChecking no&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &amp;gt;&amp;gt; ~/.ssh/config
install:
  - gem install jekyll
  - gem install html-proofer
script:
- bundle install
- bundle &lt;span class=&quot;nb&quot;&gt;exec &lt;/span&gt;jekyll build
after_success:
- git clone https://github.com/chinakevinguo/kevinguo.me.git
- &lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;kevinguo.me &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; rm -rf &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; cp -r ../_site/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; .
- git config user.name &lt;span class=&quot;s2&quot;&gt;&quot;chinakevinguo&quot;&lt;/span&gt;
- git config user.email &lt;span class=&quot;s2&quot;&gt;&quot;chinakevinguo@live.com&quot;&lt;/span&gt;
- git add --all .
- git commit -m &lt;span class=&quot;s2&quot;&gt;&quot;Travis CI Auto Builder&quot;&lt;/span&gt;
- git push --force https://&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;JEKYLL_GITHUB_TOKEN&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;@github.com/chinakevinguo/kevinguo.me.git master
- ssh root@host.kevinguo.me &lt;span class=&quot;s2&quot;&gt;&quot;docker restart chinakevinguo_jekyll_kevinguo_me&quot;&lt;/span&gt;
branches:
  only:
  - master
env:
  global:
  - &lt;span class=&quot;nv&quot;&gt;NOKOGIRI_USE_SYSTEM_LIBRARIES&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true
&lt;/span&gt;addons:
  ssh_known_hosts: host.kevinguo.me
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;7.修改镜像站点下的其他内容，比如&lt;code class=&quot;highlighter-rouge&quot;&gt;_config.yml&lt;/code&gt;，将一些内容替换成你自己的,下一篇，我将会介绍 &lt;code class=&quot;highlighter-rouge&quot;&gt;disqus&lt;/code&gt; 和 &lt;code class=&quot;highlighter-rouge&quot;&gt;cloudflare&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;8.所有内容都修改好后，&lt;code class=&quot;highlighter-rouge&quot;&gt;push&lt;/code&gt;到 Github上，会发现触发了 Travis CI，并且将生成的静态文件 &lt;code class=&quot;highlighter-rouge&quot;&gt;push&lt;/code&gt; 到了主站点仓库 &lt;code class=&quot;highlighter-rouge&quot;&gt;kevinguo.me&lt;/code&gt;，然后重启了容器&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis-done.png&quot; alt=&quot;travis-done&quot; /&gt;&lt;/p&gt;

&lt;p&gt;博客发布成功&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/jekyll-blog-done.png&quot; alt=&quot;jekyll-blog-done&quot; /&gt;&lt;/p&gt;</content><author><name>KevinGuo</name></author><summary type="html">这段时间将原来在hexo上的博客迁到了jekyll上；采用Jekyll生成静态站点，Travis CI自动化部署，记录下来，以免以后忘记了</summary></entry><entry><title type="html">video</title><link href="https://kevinguo.me/2017/07/06/video-test/" rel="alternate" type="text/html" title="video" /><published>2017-07-06T00:00:00+08:00</published><updated>2017-07-06T00:00:00+08:00</updated><id>https://kevinguo.me/2017/07/06/video-test</id><content type="html" xml:base="https://kevinguo.me/2017/07/06/video-test/">&lt;blockquote&gt;
  &lt;p&gt;就是加个视频链接，测试一下看看行不行，代码如下&lt;/p&gt;
&lt;/blockquote&gt;

&lt;!--more--&gt;

&lt;div class=&quot;language-html highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;video&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;id=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;video&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;controls=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;preload=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;none&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;height=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;498&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;width=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;510&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;poster=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;http://media.w3.org/2010/05/sintel/poster.png&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;source&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;id=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;mp4&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;src=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;http://media.w3.org/2010/05/sintel/trailer.mp4&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;video/mp4&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;source&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;id=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;webm&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;src=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;http://media.w3.org/2010/05/sintel/trailer.webm&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;video/webm&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;source&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;id=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;ogv&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;src=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;http://media.w3.org/2010/05/sintel/trailer.ogv&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;video/ogg&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/video&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;h6 id=&quot;效果如下&quot;&gt;效果如下&lt;/h6&gt;
&lt;video id=&quot;video&quot; controls=&quot;&quot; preload=&quot;none&quot;&gt;
      &lt;source id=&quot;mp4&quot; src=&quot;http://media.w3.org/2010/05/sintel/trailer.mp4&quot; type=&quot;video/mp4&quot; /&gt;
      &lt;source id=&quot;webm&quot; src=&quot;http://media.w3.org/2010/05/sintel/trailer.webm&quot; type=&quot;video/webm&quot; /&gt;
      &lt;source id=&quot;ogv&quot; src=&quot;http://media.w3.org/2010/05/sintel/trailer.ogv&quot; type=&quot;video/ogg&quot; /&gt;
    &lt;/video&gt;</content><author><name>KevinGuo</name></author><summary type="html">就是加个视频链接，测试一下看看行不行，代码如下</summary></entry><entry><title type="html">saltstack之pillar</title><link href="https://kevinguo.me/2017/07/06/saltstack%E4%B9%8Bpillar/" rel="alternate" type="text/html" title="saltstack之pillar" /><published>2017-07-06T00:00:00+08:00</published><updated>2017-07-06T00:00:00+08:00</updated><id>https://kevinguo.me/2017/07/06/saltstack%E4%B9%8Bpillar</id><content type="html" xml:base="https://kevinguo.me/2017/07/06/saltstack%E4%B9%8Bpillar/">&lt;h1 id=&quot;pillar&quot;&gt;&lt;strong&gt;Pillar&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;主要作用是存储和定义配置管理中需要的一些变量，比如数据，比如软件版本，用户名密码等信息&lt;/p&gt;

&lt;!--more--&gt;
&lt;h6 id=&quot;1在master上开启pillar_roots&quot;&gt;1.在master上开启pillar_roots&lt;/h6&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;pillar_roots&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;base&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/srv/pillar&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;!--more--&gt;
&lt;h6 id=&quot;2在master的srvpillar目录下新建topslspackagesslsservicessls&quot;&gt;2.在master的/srv/pillar目录下新建&lt;em&gt;top.sls&lt;/em&gt;，&lt;em&gt;packages.sls&lt;/em&gt;，&lt;em&gt;services.sls&lt;/em&gt;&lt;/h6&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;root@saltstack-node1 pillar&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;# cat top.sls&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;base&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;*'&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;packages&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;services&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;root@saltstack-node1 pillar&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;# cat packages.sls&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;zabbix&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;package-name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;zabbix&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;2.2.4&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;root@saltstack-node1 pillar&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;# cat services.sls&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;zabbix&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;10050&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;admin&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h6 id=&quot;3执行pillaritem-zabbix查看指定的信息&quot;&gt;3.执行pillar.item zabbix查看指定的信息&lt;/h6&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;root@saltstack-node1 pillar&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;# salt 'saltstack-node2*' pillar.item zabbix&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;saltstack-node2.example.com&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;----------&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;zabbix&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;----------&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;package-name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;zabbix&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;10050&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;admin&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;2.2.4&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;</content><author><name>KevinGuo</name></author><summary type="html">Pillar 主要作用是存储和定义配置管理中需要的一些变量，比如数据，比如软件版本，用户名密码等信息</summary></entry></feed>